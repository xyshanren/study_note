---
title: MySQL的临时笔记
author:
  - 守一
created: 2025-07-04
description: 关于MySQL的零碎问题笔记
tags:
  - mysql
---

## 下面这些MySQL参数中哪些是同时具有全局和会话作用域？
max_join_size、error_count、innodb_buffer_pool_size、sort_buffer_size、max_connections

以下是上述参数中是否具有 **全局（GLOBAL）** 和 **会话（SESSION）** 作用域的详细对比：

---

### ✅ 参数作用域对比表

| 参数名称                  | GLOBAL 作用域 | SESSION 作用域 | 说明 |
|---------------------------|----------------|-----------------|------|
| `max_join_size`           | ✅ 支持        | ✅ 支持          | 可用于限制单个查询可处理的最大行数 |
| `error_count`             | ❌ 不支持      | ✅ 支持          | 只读变量，仅在当前会话中有效 |
| `innodb_buffer_pool_size` | ✅ 支持        | ❌ 不支持        | 仅支持全局设置，且为静态参数，需重启生效 |
| `sort_buffer_size`        | ✅ 支持        | ✅ 支持          | 每个会话独立分配，可动态设置 |
| `max_connections`         | ✅ 支持        | ❌ 不支持        | 仅支持全局设置，用于控制最大连接数 |

---

### 📌 总结

具有 **同时支持 GLOBAL 和 SESSION 作用域** 的参数是：

- ✅ `max_join_size`
- ✅ `sort_buffer_size`

---

### 🔍 说明补充

- `error_count` 是一个只读的会话级状态变量，用于表示当前会话中执行语句产生的错误数。
- `innodb_buffer_pool_size` 是 InnoDB 的核心内存参数，只能全局设置，且通常需要在配置文件中设置并重启 MySQL。
- `max_connections` 是控制整个服务器最大连接数的参数，仅能全局设置。

---

## 上述参数的调优建议或适用场景

下面是这几个 MySQL 参数的详细调优建议和适用场景分析：

---

### 1. 🔍 `max_join_size`

- **作用**：限制单个查询可以处理的最大行数，防止意外的大型连接操作导致服务器资源耗尽。
- **适用场景**：
  - 防止开发或用户执行“笛卡尔积”式的大查询。
  - 多用于共享数据库环境或线上系统。
- **调优建议**：
  - 默认值为 `18446744073709551615`（无限制），可以根据业务需求设置为几百万行。
  - 可为特定用户会话设置较小值以限制资源使用：
    ```sql
    SET SESSION max_join_size = 1000000;
    ```

---

### 2. 🧮 `error_count`

- **作用**：记录当前会话中最近执行语句产生的错误数量。
- **适用场景**：
  - 用于调试或脚本中判断是否有错误发生。
- **调优建议**：
  - 只读变量，无需调优。
  - 可结合 `SHOW WARNINGS` 或 `SHOW ERRORS` 使用。

---

### 3. 🧠 `innodb_buffer_pool_size`

- **作用**：InnoDB 的核心内存缓存区，用于缓存数据页和索引页。
- **适用场景**：
  - 所有使用 InnoDB 的数据库系统，尤其是读写频繁的 OLTP 系统。
- **调优建议**：
  - 设置为物理内存的 60%–80%（专用数据库服务器）。
  - 示例配置（在 `my.cnf` 中）：
```ini
    innodb_buffer_pool_size = 8G
```
  - 对于大型系统，可结合 `innodb_buffer_pool_instances` 拆分缓冲池以提升并发性能。

---

### 4. 🧹 `sort_buffer_size`

- **作用**：每个线程用于排序操作的内存缓冲区大小。
- **适用场景**：
  - 查询中包含 `ORDER BY`、`GROUP BY`、`DISTINCT` 等操作。
- **调优建议**：
  - 默认值较小（如 256KB），可根据排序字段数量和数据量适当增大。
  - 但注意：这是**每个连接**分配的内存，设置过大可能导致内存耗尽。
```sql
    SET SESSION sort_buffer_size = 2 * 1024 * 1024;  -- 2MB
```

---

### 5. 👥 `max_connections`

- **作用**：控制允许同时连接到 MySQL 的最大客户端数量。
- **适用场景**：
  - 高并发 Web 应用、API 服务等。
- **调优建议**：
  - 根据服务器资源和连接池策略设置，常见值如 200、500、1000。
  - 设置过高可能导致系统资源耗尽（如文件描述符、内存）。
```sql
    SET GLOBAL max_connections = 500;
```
  - 配合 `wait_timeout` 和 `max_connect_errors` 控制连接行为。

---

### ✅ 总结建议

| 参数名                       | 建议用途         | 调优重点            |
| ------------------------- | ------------ | --------------- |
| `max_join_size`           | 控制大查询        | 限制单个查询行数，防止误操作  |
| `error_count`             | 会话错误监控       | 无需调优            |
| `innodb_buffer_pool_size` | 提升 InnoDB 性能 | 设置为物理内存的 60–80% |
| `sort_buffer_size`        | 提升排序性能       | 控制每连接内存使用       |
| `max_connections`         | 控制并发连接数      | 根据业务并发量和资源合理设置  |

---


## innodb引擎是否支持T-tree索引

InnoDB 存储引擎 **不支持 T-tree 索引**。它使用的是 **B+ Tree（B+ 树）索引结构**，这是关系型数据库中最常见、最有效的索引方式之一。

---

### 🌳 InnoDB 支持的索引类型

| 索引类型       | 是否支持 | 说明 |
|----------------|----------|------|
| B+ Tree 索引   | ✅ 支持   | 默认索引结构，适用于主键和二级索引 |
| Fulltext 索引  | ✅ 支持（MySQL 5.6+） | 用于全文搜索 |
| Spatial 索引   | ✅ 支持（MySQL 5.7+） | 用于地理空间数据 |
| Hash 索引      | ❌ 不直接支持（但内部可能用于自适应哈希） |
| T-tree 索引    | ❌ 不支持 | T-tree 是某些内存数据库（如 Oracle TimesTen）使用的结构 |

---

### ❓什么是 T-tree？

T-tree（平衡三叉树）是一种为**内存数据库优化**的索引结构，结合了 AVL 树和 B-tree 的特性，旨在减少内存访问次数。它常用于：

- Oracle TimesTen
- SAP HANA（部分场景）
- 其他内存优化型数据库

但它**不适合磁盘型数据库**，因此 MySQL/InnoDB 并未采用。

---

### ✅ 总结

- InnoDB 使用 **B+ Tree** 作为其主要索引结构。
- **不支持 T-tree 索引**，因为它不是为磁盘型数据库设计的。


根据 MySQL 官方文档和配置文件规范，以下是 **server-specific groups**（服务器专用组）在 `my.cnf` 配置文件中的正确选项：

---

## 在my.cnf文件中有哪些是**server-specific groups**（服务器专用组）
### ✅ 正确答案：

- **[mysqld]**：用于配置 `mysqld` 服务器守护进程的选项（最常用的服务器组）
- **[server]**：通用服务器组，`mysqld` 和其他嵌入式服务器程序也会读取
- **[mysqld_safe]**：用于配置 `mysqld_safe` 启动脚本的选项

---

### ❌ 非服务器专用组（用于客户端或特定工具）：

- **[client]**：适用于所有客户端程序（如 `mysql`, `mysqladmin`, `mysqldump` 等），但不被服务器读取
- **[mysql]**：仅适用于 `mysql` 命令行客户端
- **[mysqldump]**：仅适用于 `mysqldump` 工具

---

### 📌 总结表格

| 组名           | 类型             | 说明 |
|----------------|------------------|------|
| `[mysqld]`      | ✅ 服务器专用     | 主服务器进程配置 |
| `[server]`      | ✅ 服务器专用     | 所有服务器程序通用配置 |
| `[mysqld_safe]` | ✅ 服务器专用     | 启动脚本配置 |
| `[client]`      | ❌ 客户端通用     | 所有客户端程序读取 |
| `[mysql]`       | ❌ 客户端专用     | 仅 `mysql` 命令行工具读取 |
| `[mysqldump]`   | ❌ 客户端专用     | 仅 `mysqldump` 工具读取 |

---

可以在 [MySQL 官方文档](https://dev.mysql.com/doc/refman/8.0/en/option-files.html) 中查看更多关于配置文件的分组说明。

## Performance Schema 有什么功能？

Performance Schema 是 MySQL 提供的一个强大性能监控与诊断工具，它的功能远不止分析查询和 I/O 等待。以下是它的 **其他核心功能**：

---

### 1. **细粒度性能监控**
- 能监控从 SQL 查询到内部线程、事件、锁等多个层级的性能指标。
- 支持查看语句执行时间、等待事件、资源使用等详细信息。

### 2. **低开销设计**
- 虽然会引入一定系统开销，但设计目标是尽量降低对数据库性能的影响。
- 可按需启用或禁用不同的监控模块，灵活控制资源消耗。

### 3. **高度可配置**
- 可通过 `setup_instruments`、`setup_consumers` 等表启用/禁用特定监控项。
- 支持动态调整采样频率、数据存储位置等参数。

### 4. **内存使用监控**
- 提供 `memory_summary_global_by_event_name` 等表，分析内存使用热点。
- 可识别内存泄漏或异常增长的模块。

### 5. **锁等待分析**
- 通过 `events_waits_current` 和 `events_waits_summary_by_instance` 表，分析锁争用情况。
- 有助于优化并发性能和事务设计。

### 6. **文件与磁盘 I/O 监控**
- 监控文件读写次数、耗时、文件路径等，识别 I/O 瓶颈。
- 表如 `file_summary_by_instance` 提供详细统计。

### 7. **线程与会话分析**
- 可查看当前活跃线程、连接状态、执行语句等。
- 支持分析慢连接、空闲连接等问题。

### 8. **结合 sys schema 简化使用**
- `sys` schema 提供了基于 Performance Schema 的视图，简化查询。
- 如 `sys.host_summary_by_statement_latency` 可快速查看主机执行效率。

---

### 📘 推荐阅读资源

| 📄 文章标题 | 简介 | 链接 |
|------------|------|------|
| MySQL 性能调优必知：Performance Schema 引擎的配置与使用 | 深入讲解 Performance Schema 的配置、使用场景与优化技巧 | [阅读文章](https://www.cnblogs.com/xiaoxi-jinchen/p/17137240.html) |
| MySQL Performance Schema 详解及运行时配置优化 | 介绍运行时如何灵活调整监控内容，适应高并发场景 | [阅读文章](https://www.cnblogs.com/bu-huo/p/18597105.html) |
| Performance Schema 性能监控组件详解 | 结构、数据流、典型使用场景全面解析 | [阅读文章](https://blog.csdn.net/exlink2012/article/details/146143716) |

## 通用查询日志的作用
根据如下选项分析：
A.To record all statements executed against all tables
B.To record the time and type of each connection and the process ID of all operations
C.To discover queries with excessive execution time.
D.To record statements where execution time exceeds a specified threshold
E.To include update operations stored as row-based binary logs on slave servers

根据对 MySQL 官方文档和技术社区的分析，**General Query Log（通用查询日志）** 的主要用途如下：

---

### ✅ 正确答案（选择两个）

#### ✅ A. **记录对所有表执行的所有语句**
- General Query Log 会记录所有客户端发送到 MySQL 服务器的 SQL 语句，无论是否执行成功。
- 包括 `SELECT`、`INSERT`、`UPDATE`、`DELETE` 等所有类型的语句。

#### ✅ B. **记录每个连接的时间、类型和操作的进程 ID**
- 日志中会记录每个客户端连接的开始和结束时间、连接类型（如 TCP/IP、本地 socket）、线程 ID 等信息。
- 这对于审计和排查连接问题非常有用。

---

### ❌ 错误选项解析

#### ❌ C. 发现执行时间过长的查询  
这是 **慢查询日志（Slow Query Log）** 的功能，而不是 General Query Log 的职责。

#### ❌ D. 记录执行时间超过指定阈值的语句  
同样属于 **慢查询日志** 的功能，General Query Log 不会根据执行时间筛选记录。

#### ❌ E. 包含从服务器上以行格式存储的更新操作  
这是 **二进制日志（Binary Log）** 的功能，尤其是用于主从复制的场景，与 General Query Log 无关。

---

### 📌 总结

| 功能 | 是否属于 General Query Log |
|------|-----------------------------|
| 记录所有 SQL 语句 | ✅ 是 |
| 记录连接信息 | ✅ 是 |
| 记录慢查询 | ❌ 否（属于慢查询日志） |
| 记录执行时间阈值 | ❌ 否 |
| 记录主从复制更新 | ❌ 否（属于二进制日志） |

## MySQL Performance Schema 中哪些工具没有子组件？
根据以下选项分析：
error
stage
statement
transaction
memory
idle

根据对 MySQL Performance Schema 的结构分析，以下 **三种 instruments（检测点）没有子组件（subcomponents）**，即它们是顶层事件类型，不再细分为更小的子类：

---

### ✅ 正确答案（选择三个）

#### 1. ✅ **error**
- 用于记录错误事件，如 SQL 执行错误、连接失败等。
- 是独立的事件类型，没有进一步的子分类。

#### 2. ✅ **transaction**
- 用于监控事务的开始、提交、回滚等操作。
- 是一个完整的逻辑单元，不再细分为子事件。

#### 3. ✅ **idle**
- 表示线程处于空闲状态（如等待客户端请求）。
- 是一种特殊的状态事件，没有子组件。

---

### ❌ 错误选项解析

| 选项 | 是否有子组件 | 说明 |
|------|--------------|------|
| ❌ **stage** | 有 | 如 `stage/sql/Sorting result`、`stage/sql/Sending data` 等，表示 SQL 执行过程的不同阶段。 |
| ❌ **statement** | 有 | 如 `statement/sql/select`、`statement/sql/insert` 等，表示不同类型的 SQL 语句。 |
| ❌ **memory** | 有 | 如 `memory/sql/THD::mem_root`、`memory/innodb/buf_buf_pool` 等，表示不同模块的内存使用。 |

---

### 📘 拓展阅读推荐

你可以参考这篇文章深入了解 Performance Schema 的 instrument 分类与结构：[MySQL中的Performance Schema性能监控组件](https://blog.csdn.net/exlink2012/article/details/146143716)。




