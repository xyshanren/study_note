---
title: MySQLçš„ä¸´æ—¶ç¬”è®°
author:
  - å®ˆä¸€
created: 2025-07-04
description: å…³äºMySQLçš„é›¶ç¢é—®é¢˜ç¬”è®°
tags:
  - mysql
---

## ä¸‹é¢è¿™äº›MySQLå‚æ•°ä¸­å“ªäº›æ˜¯åŒæ—¶å…·æœ‰å…¨å±€å’Œä¼šè¯ä½œç”¨åŸŸï¼Ÿ
max_join_sizeã€error_countã€innodb_buffer_pool_sizeã€sort_buffer_sizeã€max_connections

ä»¥ä¸‹æ˜¯ä¸Šè¿°å‚æ•°ä¸­æ˜¯å¦å…·æœ‰ **å…¨å±€ï¼ˆGLOBALï¼‰** å’Œ **ä¼šè¯ï¼ˆSESSIONï¼‰** ä½œç”¨åŸŸçš„è¯¦ç»†å¯¹æ¯”ï¼š

---

### âœ… å‚æ•°ä½œç”¨åŸŸå¯¹æ¯”è¡¨

| å‚æ•°åç§°                  | GLOBAL ä½œç”¨åŸŸ | SESSION ä½œç”¨åŸŸ | è¯´æ˜ |
|---------------------------|----------------|-----------------|------|
| `max_join_size`           | âœ… æ”¯æŒ        | âœ… æ”¯æŒ          | å¯ç”¨äºé™åˆ¶å•ä¸ªæŸ¥è¯¢å¯å¤„ç†çš„æœ€å¤§è¡Œæ•° |
| `error_count`             | âŒ ä¸æ”¯æŒ      | âœ… æ”¯æŒ          | åªè¯»å˜é‡ï¼Œä»…åœ¨å½“å‰ä¼šè¯ä¸­æœ‰æ•ˆ |
| `innodb_buffer_pool_size` | âœ… æ”¯æŒ        | âŒ ä¸æ”¯æŒ        | ä»…æ”¯æŒå…¨å±€è®¾ç½®ï¼Œä¸”ä¸ºé™æ€å‚æ•°ï¼Œéœ€é‡å¯ç”Ÿæ•ˆ |
| `sort_buffer_size`        | âœ… æ”¯æŒ        | âœ… æ”¯æŒ          | æ¯ä¸ªä¼šè¯ç‹¬ç«‹åˆ†é…ï¼Œå¯åŠ¨æ€è®¾ç½® |
| `max_connections`         | âœ… æ”¯æŒ        | âŒ ä¸æ”¯æŒ        | ä»…æ”¯æŒå…¨å±€è®¾ç½®ï¼Œç”¨äºæ§åˆ¶æœ€å¤§è¿æ¥æ•° |

---

### ğŸ“Œ æ€»ç»“

å…·æœ‰ **åŒæ—¶æ”¯æŒ GLOBAL å’Œ SESSION ä½œç”¨åŸŸ** çš„å‚æ•°æ˜¯ï¼š

- âœ… `max_join_size`
- âœ… `sort_buffer_size`

---

### ğŸ” è¯´æ˜è¡¥å……

- `error_count` æ˜¯ä¸€ä¸ªåªè¯»çš„ä¼šè¯çº§çŠ¶æ€å˜é‡ï¼Œç”¨äºè¡¨ç¤ºå½“å‰ä¼šè¯ä¸­æ‰§è¡Œè¯­å¥äº§ç”Ÿçš„é”™è¯¯æ•°ã€‚
- `innodb_buffer_pool_size` æ˜¯ InnoDB çš„æ ¸å¿ƒå†…å­˜å‚æ•°ï¼Œåªèƒ½å…¨å±€è®¾ç½®ï¼Œä¸”é€šå¸¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®å¹¶é‡å¯ MySQLã€‚
- `max_connections` æ˜¯æ§åˆ¶æ•´ä¸ªæœåŠ¡å™¨æœ€å¤§è¿æ¥æ•°çš„å‚æ•°ï¼Œä»…èƒ½å…¨å±€è®¾ç½®ã€‚

---

## ä¸Šè¿°å‚æ•°çš„è°ƒä¼˜å»ºè®®æˆ–é€‚ç”¨åœºæ™¯

ä¸‹é¢æ˜¯è¿™å‡ ä¸ª MySQL å‚æ•°çš„è¯¦ç»†è°ƒä¼˜å»ºè®®å’Œé€‚ç”¨åœºæ™¯åˆ†æï¼š

---

### 1. ğŸ” `max_join_size`

- **ä½œç”¨**ï¼šé™åˆ¶å•ä¸ªæŸ¥è¯¢å¯ä»¥å¤„ç†çš„æœ€å¤§è¡Œæ•°ï¼Œé˜²æ­¢æ„å¤–çš„å¤§å‹è¿æ¥æ“ä½œå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - é˜²æ­¢å¼€å‘æˆ–ç”¨æˆ·æ‰§è¡Œâ€œç¬›å¡å°”ç§¯â€å¼çš„å¤§æŸ¥è¯¢ã€‚
  - å¤šç”¨äºå…±äº«æ•°æ®åº“ç¯å¢ƒæˆ–çº¿ä¸Šç³»ç»Ÿã€‚
- **è°ƒä¼˜å»ºè®®**ï¼š
  - é»˜è®¤å€¼ä¸º `18446744073709551615`ï¼ˆæ— é™åˆ¶ï¼‰ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®ä¸ºå‡ ç™¾ä¸‡è¡Œã€‚
  - å¯ä¸ºç‰¹å®šç”¨æˆ·ä¼šè¯è®¾ç½®è¾ƒå°å€¼ä»¥é™åˆ¶èµ„æºä½¿ç”¨ï¼š
    ```sql
    SET SESSION max_join_size = 1000000;
    ```

---

### 2. ğŸ§® `error_count`

- **ä½œç”¨**ï¼šè®°å½•å½“å‰ä¼šè¯ä¸­æœ€è¿‘æ‰§è¡Œè¯­å¥äº§ç”Ÿçš„é”™è¯¯æ•°é‡ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - ç”¨äºè°ƒè¯•æˆ–è„šæœ¬ä¸­åˆ¤æ–­æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿã€‚
- **è°ƒä¼˜å»ºè®®**ï¼š
  - åªè¯»å˜é‡ï¼Œæ— éœ€è°ƒä¼˜ã€‚
  - å¯ç»“åˆ `SHOW WARNINGS` æˆ– `SHOW ERRORS` ä½¿ç”¨ã€‚

---

### 3. ğŸ§  `innodb_buffer_pool_size`

- **ä½œç”¨**ï¼šInnoDB çš„æ ¸å¿ƒå†…å­˜ç¼“å­˜åŒºï¼Œç”¨äºç¼“å­˜æ•°æ®é¡µå’Œç´¢å¼•é¡µã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - æ‰€æœ‰ä½¿ç”¨ InnoDB çš„æ•°æ®åº“ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯è¯»å†™é¢‘ç¹çš„ OLTP ç³»ç»Ÿã€‚
- **è°ƒä¼˜å»ºè®®**ï¼š
  - è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 60%â€“80%ï¼ˆä¸“ç”¨æ•°æ®åº“æœåŠ¡å™¨ï¼‰ã€‚
  - ç¤ºä¾‹é…ç½®ï¼ˆåœ¨ `my.cnf` ä¸­ï¼‰ï¼š
```ini
    innodb_buffer_pool_size = 8G
```
  - å¯¹äºå¤§å‹ç³»ç»Ÿï¼Œå¯ç»“åˆ `innodb_buffer_pool_instances` æ‹†åˆ†ç¼“å†²æ± ä»¥æå‡å¹¶å‘æ€§èƒ½ã€‚

---

### 4. ğŸ§¹ `sort_buffer_size`

- **ä½œç”¨**ï¼šæ¯ä¸ªçº¿ç¨‹ç”¨äºæ’åºæ“ä½œçš„å†…å­˜ç¼“å†²åŒºå¤§å°ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - æŸ¥è¯¢ä¸­åŒ…å« `ORDER BY`ã€`GROUP BY`ã€`DISTINCT` ç­‰æ“ä½œã€‚
- **è°ƒä¼˜å»ºè®®**ï¼š
  - é»˜è®¤å€¼è¾ƒå°ï¼ˆå¦‚ 256KBï¼‰ï¼Œå¯æ ¹æ®æ’åºå­—æ®µæ•°é‡å’Œæ•°æ®é‡é€‚å½“å¢å¤§ã€‚
  - ä½†æ³¨æ„ï¼šè¿™æ˜¯**æ¯ä¸ªè¿æ¥**åˆ†é…çš„å†…å­˜ï¼Œè®¾ç½®è¿‡å¤§å¯èƒ½å¯¼è‡´å†…å­˜è€—å°½ã€‚
```sql
    SET SESSION sort_buffer_size = 2 * 1024 * 1024;  -- 2MB
```

---

### 5. ğŸ‘¥ `max_connections`

- **ä½œç”¨**ï¼šæ§åˆ¶å…è®¸åŒæ—¶è¿æ¥åˆ° MySQL çš„æœ€å¤§å®¢æˆ·ç«¯æ•°é‡ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
  - é«˜å¹¶å‘ Web åº”ç”¨ã€API æœåŠ¡ç­‰ã€‚
- **è°ƒä¼˜å»ºè®®**ï¼š
  - æ ¹æ®æœåŠ¡å™¨èµ„æºå’Œè¿æ¥æ± ç­–ç•¥è®¾ç½®ï¼Œå¸¸è§å€¼å¦‚ 200ã€500ã€1000ã€‚
  - è®¾ç½®è¿‡é«˜å¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ï¼ˆå¦‚æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜ï¼‰ã€‚
```sql
    SET GLOBAL max_connections = 500;
```
  - é…åˆ `wait_timeout` å’Œ `max_connect_errors` æ§åˆ¶è¿æ¥è¡Œä¸ºã€‚

---

### âœ… æ€»ç»“å»ºè®®

| å‚æ•°å                       | å»ºè®®ç”¨é€”         | è°ƒä¼˜é‡ç‚¹            |
| ------------------------- | ------------ | --------------- |
| `max_join_size`           | æ§åˆ¶å¤§æŸ¥è¯¢        | é™åˆ¶å•ä¸ªæŸ¥è¯¢è¡Œæ•°ï¼Œé˜²æ­¢è¯¯æ“ä½œ  |
| `error_count`             | ä¼šè¯é”™è¯¯ç›‘æ§       | æ— éœ€è°ƒä¼˜            |
| `innodb_buffer_pool_size` | æå‡ InnoDB æ€§èƒ½ | è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„ 60â€“80% |
| `sort_buffer_size`        | æå‡æ’åºæ€§èƒ½       | æ§åˆ¶æ¯è¿æ¥å†…å­˜ä½¿ç”¨       |
| `max_connections`         | æ§åˆ¶å¹¶å‘è¿æ¥æ•°      | æ ¹æ®ä¸šåŠ¡å¹¶å‘é‡å’Œèµ„æºåˆç†è®¾ç½®  |

---


## innodbå¼•æ“æ˜¯å¦æ”¯æŒT-treeç´¢å¼•

InnoDB å­˜å‚¨å¼•æ“ **ä¸æ”¯æŒ T-tree ç´¢å¼•**ã€‚å®ƒä½¿ç”¨çš„æ˜¯ **B+ Treeï¼ˆB+ æ ‘ï¼‰ç´¢å¼•ç»“æ„**ï¼Œè¿™æ˜¯å…³ç³»å‹æ•°æ®åº“ä¸­æœ€å¸¸è§ã€æœ€æœ‰æ•ˆçš„ç´¢å¼•æ–¹å¼ä¹‹ä¸€ã€‚

---

### ğŸŒ³ InnoDB æ”¯æŒçš„ç´¢å¼•ç±»å‹

| ç´¢å¼•ç±»å‹       | æ˜¯å¦æ”¯æŒ | è¯´æ˜ |
|----------------|----------|------|
| B+ Tree ç´¢å¼•   | âœ… æ”¯æŒ   | é»˜è®¤ç´¢å¼•ç»“æ„ï¼Œé€‚ç”¨äºä¸»é”®å’ŒäºŒçº§ç´¢å¼• |
| Fulltext ç´¢å¼•  | âœ… æ”¯æŒï¼ˆMySQL 5.6+ï¼‰ | ç”¨äºå…¨æ–‡æœç´¢ |
| Spatial ç´¢å¼•   | âœ… æ”¯æŒï¼ˆMySQL 5.7+ï¼‰ | ç”¨äºåœ°ç†ç©ºé—´æ•°æ® |
| Hash ç´¢å¼•      | âŒ ä¸ç›´æ¥æ”¯æŒï¼ˆä½†å†…éƒ¨å¯èƒ½ç”¨äºè‡ªé€‚åº”å“ˆå¸Œï¼‰ |
| T-tree ç´¢å¼•    | âŒ ä¸æ”¯æŒ | T-tree æ˜¯æŸäº›å†…å­˜æ•°æ®åº“ï¼ˆå¦‚ Oracle TimesTenï¼‰ä½¿ç”¨çš„ç»“æ„ |

---

### â“ä»€ä¹ˆæ˜¯ T-treeï¼Ÿ

T-treeï¼ˆå¹³è¡¡ä¸‰å‰æ ‘ï¼‰æ˜¯ä¸€ç§ä¸º**å†…å­˜æ•°æ®åº“ä¼˜åŒ–**çš„ç´¢å¼•ç»“æ„ï¼Œç»“åˆäº† AVL æ ‘å’Œ B-tree çš„ç‰¹æ€§ï¼Œæ—¨åœ¨å‡å°‘å†…å­˜è®¿é—®æ¬¡æ•°ã€‚å®ƒå¸¸ç”¨äºï¼š

- Oracle TimesTen
- SAP HANAï¼ˆéƒ¨åˆ†åœºæ™¯ï¼‰
- å…¶ä»–å†…å­˜ä¼˜åŒ–å‹æ•°æ®åº“

ä½†å®ƒ**ä¸é€‚åˆç£ç›˜å‹æ•°æ®åº“**ï¼Œå› æ­¤ MySQL/InnoDB å¹¶æœªé‡‡ç”¨ã€‚

---

### âœ… æ€»ç»“

- InnoDB ä½¿ç”¨ **B+ Tree** ä½œä¸ºå…¶ä¸»è¦ç´¢å¼•ç»“æ„ã€‚
- **ä¸æ”¯æŒ T-tree ç´¢å¼•**ï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸ºç£ç›˜å‹æ•°æ®åº“è®¾è®¡çš„ã€‚


æ ¹æ® MySQL å®˜æ–¹æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶è§„èŒƒï¼Œä»¥ä¸‹æ˜¯ **server-specific groups**ï¼ˆæœåŠ¡å™¨ä¸“ç”¨ç»„ï¼‰åœ¨ `my.cnf` é…ç½®æ–‡ä»¶ä¸­çš„æ­£ç¡®é€‰é¡¹ï¼š

---

## åœ¨my.cnfæ–‡ä»¶ä¸­æœ‰å“ªäº›æ˜¯**server-specific groups**ï¼ˆæœåŠ¡å™¨ä¸“ç”¨ç»„ï¼‰
### âœ… æ­£ç¡®ç­”æ¡ˆï¼š

- **[mysqld]**ï¼šç”¨äºé…ç½® `mysqld` æœåŠ¡å™¨å®ˆæŠ¤è¿›ç¨‹çš„é€‰é¡¹ï¼ˆæœ€å¸¸ç”¨çš„æœåŠ¡å™¨ç»„ï¼‰
- **[server]**ï¼šé€šç”¨æœåŠ¡å™¨ç»„ï¼Œ`mysqld` å’Œå…¶ä»–åµŒå…¥å¼æœåŠ¡å™¨ç¨‹åºä¹Ÿä¼šè¯»å–
- **[mysqld_safe]**ï¼šç”¨äºé…ç½® `mysqld_safe` å¯åŠ¨è„šæœ¬çš„é€‰é¡¹

---

### âŒ éæœåŠ¡å™¨ä¸“ç”¨ç»„ï¼ˆç”¨äºå®¢æˆ·ç«¯æˆ–ç‰¹å®šå·¥å…·ï¼‰ï¼š

- **[client]**ï¼šé€‚ç”¨äºæ‰€æœ‰å®¢æˆ·ç«¯ç¨‹åºï¼ˆå¦‚ `mysql`, `mysqladmin`, `mysqldump` ç­‰ï¼‰ï¼Œä½†ä¸è¢«æœåŠ¡å™¨è¯»å–
- **[mysql]**ï¼šä»…é€‚ç”¨äº `mysql` å‘½ä»¤è¡Œå®¢æˆ·ç«¯
- **[mysqldump]**ï¼šä»…é€‚ç”¨äº `mysqldump` å·¥å…·

---

### ğŸ“Œ æ€»ç»“è¡¨æ ¼

| ç»„å           | ç±»å‹             | è¯´æ˜ |
|----------------|------------------|------|
| `[mysqld]`      | âœ… æœåŠ¡å™¨ä¸“ç”¨     | ä¸»æœåŠ¡å™¨è¿›ç¨‹é…ç½® |
| `[server]`      | âœ… æœåŠ¡å™¨ä¸“ç”¨     | æ‰€æœ‰æœåŠ¡å™¨ç¨‹åºé€šç”¨é…ç½® |
| `[mysqld_safe]` | âœ… æœåŠ¡å™¨ä¸“ç”¨     | å¯åŠ¨è„šæœ¬é…ç½® |
| `[client]`      | âŒ å®¢æˆ·ç«¯é€šç”¨     | æ‰€æœ‰å®¢æˆ·ç«¯ç¨‹åºè¯»å– |
| `[mysql]`       | âŒ å®¢æˆ·ç«¯ä¸“ç”¨     | ä»… `mysql` å‘½ä»¤è¡Œå·¥å…·è¯»å– |
| `[mysqldump]`   | âŒ å®¢æˆ·ç«¯ä¸“ç”¨     | ä»… `mysqldump` å·¥å…·è¯»å– |

---

å¯ä»¥åœ¨ [MySQL å®˜æ–¹æ–‡æ¡£](https://dev.mysql.com/doc/refman/8.0/en/option-files.html) ä¸­æŸ¥çœ‹æ›´å¤šå…³äºé…ç½®æ–‡ä»¶çš„åˆ†ç»„è¯´æ˜ã€‚

## Performance Schema æœ‰ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ

Performance Schema æ˜¯ MySQL æä¾›çš„ä¸€ä¸ªå¼ºå¤§æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­å·¥å…·ï¼Œå®ƒçš„åŠŸèƒ½è¿œä¸æ­¢åˆ†ææŸ¥è¯¢å’Œ I/O ç­‰å¾…ã€‚ä»¥ä¸‹æ˜¯å®ƒçš„ **å…¶ä»–æ ¸å¿ƒåŠŸèƒ½**ï¼š

---

### 1. **ç»†ç²’åº¦æ€§èƒ½ç›‘æ§**
- èƒ½ç›‘æ§ä» SQL æŸ¥è¯¢åˆ°å†…éƒ¨çº¿ç¨‹ã€äº‹ä»¶ã€é”ç­‰å¤šä¸ªå±‚çº§çš„æ€§èƒ½æŒ‡æ ‡ã€‚
- æ”¯æŒæŸ¥çœ‹è¯­å¥æ‰§è¡Œæ—¶é—´ã€ç­‰å¾…äº‹ä»¶ã€èµ„æºä½¿ç”¨ç­‰è¯¦ç»†ä¿¡æ¯ã€‚

### 2. **ä½å¼€é”€è®¾è®¡**
- è™½ç„¶ä¼šå¼•å…¥ä¸€å®šç³»ç»Ÿå¼€é”€ï¼Œä½†è®¾è®¡ç›®æ ‡æ˜¯å°½é‡é™ä½å¯¹æ•°æ®åº“æ€§èƒ½çš„å½±å“ã€‚
- å¯æŒ‰éœ€å¯ç”¨æˆ–ç¦ç”¨ä¸åŒçš„ç›‘æ§æ¨¡å—ï¼Œçµæ´»æ§åˆ¶èµ„æºæ¶ˆè€—ã€‚

### 3. **é«˜åº¦å¯é…ç½®**
- å¯é€šè¿‡ `setup_instruments`ã€`setup_consumers` ç­‰è¡¨å¯ç”¨/ç¦ç”¨ç‰¹å®šç›‘æ§é¡¹ã€‚
- æ”¯æŒåŠ¨æ€è°ƒæ•´é‡‡æ ·é¢‘ç‡ã€æ•°æ®å­˜å‚¨ä½ç½®ç­‰å‚æ•°ã€‚

### 4. **å†…å­˜ä½¿ç”¨ç›‘æ§**
- æä¾› `memory_summary_global_by_event_name` ç­‰è¡¨ï¼Œåˆ†æå†…å­˜ä½¿ç”¨çƒ­ç‚¹ã€‚
- å¯è¯†åˆ«å†…å­˜æ³„æ¼æˆ–å¼‚å¸¸å¢é•¿çš„æ¨¡å—ã€‚

### 5. **é”ç­‰å¾…åˆ†æ**
- é€šè¿‡ `events_waits_current` å’Œ `events_waits_summary_by_instance` è¡¨ï¼Œåˆ†æé”äº‰ç”¨æƒ…å†µã€‚
- æœ‰åŠ©äºä¼˜åŒ–å¹¶å‘æ€§èƒ½å’Œäº‹åŠ¡è®¾è®¡ã€‚

### 6. **æ–‡ä»¶ä¸ç£ç›˜ I/O ç›‘æ§**
- ç›‘æ§æ–‡ä»¶è¯»å†™æ¬¡æ•°ã€è€—æ—¶ã€æ–‡ä»¶è·¯å¾„ç­‰ï¼Œè¯†åˆ« I/O ç“¶é¢ˆã€‚
- è¡¨å¦‚ `file_summary_by_instance` æä¾›è¯¦ç»†ç»Ÿè®¡ã€‚

### 7. **çº¿ç¨‹ä¸ä¼šè¯åˆ†æ**
- å¯æŸ¥çœ‹å½“å‰æ´»è·ƒçº¿ç¨‹ã€è¿æ¥çŠ¶æ€ã€æ‰§è¡Œè¯­å¥ç­‰ã€‚
- æ”¯æŒåˆ†ææ…¢è¿æ¥ã€ç©ºé—²è¿æ¥ç­‰é—®é¢˜ã€‚

### 8. **ç»“åˆ sys schema ç®€åŒ–ä½¿ç”¨**
- `sys` schema æä¾›äº†åŸºäº Performance Schema çš„è§†å›¾ï¼Œç®€åŒ–æŸ¥è¯¢ã€‚
- å¦‚ `sys.host_summary_by_statement_latency` å¯å¿«é€ŸæŸ¥çœ‹ä¸»æœºæ‰§è¡Œæ•ˆç‡ã€‚

---

### ğŸ“˜ æ¨èé˜…è¯»èµ„æº

| ğŸ“„ æ–‡ç« æ ‡é¢˜ | ç®€ä»‹ | é“¾æ¥ |
|------------|------|------|
| MySQL æ€§èƒ½è°ƒä¼˜å¿…çŸ¥ï¼šPerformance Schema å¼•æ“çš„é…ç½®ä¸ä½¿ç”¨ | æ·±å…¥è®²è§£ Performance Schema çš„é…ç½®ã€ä½¿ç”¨åœºæ™¯ä¸ä¼˜åŒ–æŠ€å·§ | [é˜…è¯»æ–‡ç« ](https://www.cnblogs.com/xiaoxi-jinchen/p/17137240.html) |
| MySQL Performance Schema è¯¦è§£åŠè¿è¡Œæ—¶é…ç½®ä¼˜åŒ– | ä»‹ç»è¿è¡Œæ—¶å¦‚ä½•çµæ´»è°ƒæ•´ç›‘æ§å†…å®¹ï¼Œé€‚åº”é«˜å¹¶å‘åœºæ™¯ | [é˜…è¯»æ–‡ç« ](https://www.cnblogs.com/bu-huo/p/18597105.html) |
| Performance Schema æ€§èƒ½ç›‘æ§ç»„ä»¶è¯¦è§£ | ç»“æ„ã€æ•°æ®æµã€å…¸å‹ä½¿ç”¨åœºæ™¯å…¨é¢è§£æ | [é˜…è¯»æ–‡ç« ](https://blog.csdn.net/exlink2012/article/details/146143716) |

## é€šç”¨æŸ¥è¯¢æ—¥å¿—çš„ä½œç”¨
æ ¹æ®å¦‚ä¸‹é€‰é¡¹åˆ†æï¼š
A.To record all statements executed against all tables
B.To record the time and type of each connection and the process ID of all operations
C.To discover queries with excessive execution time.
D.To record statements where execution time exceeds a specified threshold
E.To include update operations stored as row-based binary logs on slave servers

æ ¹æ®å¯¹ MySQL å®˜æ–¹æ–‡æ¡£å’ŒæŠ€æœ¯ç¤¾åŒºçš„åˆ†æï¼Œ**General Query Logï¼ˆé€šç”¨æŸ¥è¯¢æ—¥å¿—ï¼‰** çš„ä¸»è¦ç”¨é€”å¦‚ä¸‹ï¼š

---

### âœ… æ­£ç¡®ç­”æ¡ˆï¼ˆé€‰æ‹©ä¸¤ä¸ªï¼‰

#### âœ… A. **è®°å½•å¯¹æ‰€æœ‰è¡¨æ‰§è¡Œçš„æ‰€æœ‰è¯­å¥**
- General Query Log ä¼šè®°å½•æ‰€æœ‰å®¢æˆ·ç«¯å‘é€åˆ° MySQL æœåŠ¡å™¨çš„ SQL è¯­å¥ï¼Œæ— è®ºæ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚
- åŒ…æ‹¬ `SELECT`ã€`INSERT`ã€`UPDATE`ã€`DELETE` ç­‰æ‰€æœ‰ç±»å‹çš„è¯­å¥ã€‚

#### âœ… B. **è®°å½•æ¯ä¸ªè¿æ¥çš„æ—¶é—´ã€ç±»å‹å’Œæ“ä½œçš„è¿›ç¨‹ ID**
- æ—¥å¿—ä¸­ä¼šè®°å½•æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„å¼€å§‹å’Œç»“æŸæ—¶é—´ã€è¿æ¥ç±»å‹ï¼ˆå¦‚ TCP/IPã€æœ¬åœ° socketï¼‰ã€çº¿ç¨‹ ID ç­‰ä¿¡æ¯ã€‚
- è¿™å¯¹äºå®¡è®¡å’Œæ’æŸ¥è¿æ¥é—®é¢˜éå¸¸æœ‰ç”¨ã€‚

---

### âŒ é”™è¯¯é€‰é¡¹è§£æ

#### âŒ C. å‘ç°æ‰§è¡Œæ—¶é—´è¿‡é•¿çš„æŸ¥è¯¢  
è¿™æ˜¯ **æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆSlow Query Logï¼‰** çš„åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ General Query Log çš„èŒè´£ã€‚

#### âŒ D. è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šé˜ˆå€¼çš„è¯­å¥  
åŒæ ·å±äº **æ…¢æŸ¥è¯¢æ—¥å¿—** çš„åŠŸèƒ½ï¼ŒGeneral Query Log ä¸ä¼šæ ¹æ®æ‰§è¡Œæ—¶é—´ç­›é€‰è®°å½•ã€‚

#### âŒ E. åŒ…å«ä»æœåŠ¡å™¨ä¸Šä»¥è¡Œæ ¼å¼å­˜å‚¨çš„æ›´æ–°æ“ä½œ  
è¿™æ˜¯ **äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinary Logï¼‰** çš„åŠŸèƒ½ï¼Œå°¤å…¶æ˜¯ç”¨äºä¸»ä»å¤åˆ¶çš„åœºæ™¯ï¼Œä¸ General Query Log æ— å…³ã€‚

---

### ğŸ“Œ æ€»ç»“

| åŠŸèƒ½ | æ˜¯å¦å±äº General Query Log |
|------|-----------------------------|
| è®°å½•æ‰€æœ‰ SQL è¯­å¥ | âœ… æ˜¯ |
| è®°å½•è¿æ¥ä¿¡æ¯ | âœ… æ˜¯ |
| è®°å½•æ…¢æŸ¥è¯¢ | âŒ å¦ï¼ˆå±äºæ…¢æŸ¥è¯¢æ—¥å¿—ï¼‰ |
| è®°å½•æ‰§è¡Œæ—¶é—´é˜ˆå€¼ | âŒ å¦ |
| è®°å½•ä¸»ä»å¤åˆ¶æ›´æ–° | âŒ å¦ï¼ˆå±äºäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ |

## MySQL Performance Schema ä¸­å“ªäº›å·¥å…·æ²¡æœ‰å­ç»„ä»¶ï¼Ÿ
æ ¹æ®ä»¥ä¸‹é€‰é¡¹åˆ†æï¼š
error
stage
statement
transaction
memory
idle

æ ¹æ®å¯¹ MySQL Performance Schema çš„ç»“æ„åˆ†æï¼Œä»¥ä¸‹ **ä¸‰ç§ instrumentsï¼ˆæ£€æµ‹ç‚¹ï¼‰æ²¡æœ‰å­ç»„ä»¶ï¼ˆsubcomponentsï¼‰**ï¼Œå³å®ƒä»¬æ˜¯é¡¶å±‚äº‹ä»¶ç±»å‹ï¼Œä¸å†ç»†åˆ†ä¸ºæ›´å°çš„å­ç±»ï¼š

---

### âœ… æ­£ç¡®ç­”æ¡ˆï¼ˆé€‰æ‹©ä¸‰ä¸ªï¼‰

#### 1. âœ… **error**
- ç”¨äºè®°å½•é”™è¯¯äº‹ä»¶ï¼Œå¦‚ SQL æ‰§è¡Œé”™è¯¯ã€è¿æ¥å¤±è´¥ç­‰ã€‚
- æ˜¯ç‹¬ç«‹çš„äº‹ä»¶ç±»å‹ï¼Œæ²¡æœ‰è¿›ä¸€æ­¥çš„å­åˆ†ç±»ã€‚

#### 2. âœ… **transaction**
- ç”¨äºç›‘æ§äº‹åŠ¡çš„å¼€å§‹ã€æäº¤ã€å›æ»šç­‰æ“ä½œã€‚
- æ˜¯ä¸€ä¸ªå®Œæ•´çš„é€»è¾‘å•å…ƒï¼Œä¸å†ç»†åˆ†ä¸ºå­äº‹ä»¶ã€‚

#### 3. âœ… **idle**
- è¡¨ç¤ºçº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€ï¼ˆå¦‚ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚ï¼‰ã€‚
- æ˜¯ä¸€ç§ç‰¹æ®Šçš„çŠ¶æ€äº‹ä»¶ï¼Œæ²¡æœ‰å­ç»„ä»¶ã€‚

---

### âŒ é”™è¯¯é€‰é¡¹è§£æ

| é€‰é¡¹ | æ˜¯å¦æœ‰å­ç»„ä»¶ | è¯´æ˜ |
|------|--------------|------|
| âŒ **stage** | æœ‰ | å¦‚ `stage/sql/Sorting result`ã€`stage/sql/Sending data` ç­‰ï¼Œè¡¨ç¤º SQL æ‰§è¡Œè¿‡ç¨‹çš„ä¸åŒé˜¶æ®µã€‚ |
| âŒ **statement** | æœ‰ | å¦‚ `statement/sql/select`ã€`statement/sql/insert` ç­‰ï¼Œè¡¨ç¤ºä¸åŒç±»å‹çš„ SQL è¯­å¥ã€‚ |
| âŒ **memory** | æœ‰ | å¦‚ `memory/sql/THD::mem_root`ã€`memory/innodb/buf_buf_pool` ç­‰ï¼Œè¡¨ç¤ºä¸åŒæ¨¡å—çš„å†…å­˜ä½¿ç”¨ã€‚ |

---

### ğŸ“˜ æ‹“å±•é˜…è¯»æ¨è

ä½ å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« æ·±å…¥äº†è§£ Performance Schema çš„ instrument åˆ†ç±»ä¸ç»“æ„ï¼š[MySQLä¸­çš„Performance Schemaæ€§èƒ½ç›‘æ§ç»„ä»¶](https://blog.csdn.net/exlink2012/article/details/146143716)ã€‚


## å…³äºMySQLçš„test_plugin_serveræ’ä»¶çš„åŠŸèƒ½

MySQL çš„ `test_plugin_server` æ’ä»¶æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•å’Œæ¼”ç¤ºçš„å¯æ’æ‹”èº«ä»½éªŒè¯æ’ä»¶ï¼Œä¸»è¦ç”¨äºå¼€å‘è€…å­¦ä¹ å¦‚ä½•ç¼–å†™è‡ªå®šä¹‰èº«ä»½éªŒè¯æ’ä»¶ã€‚ä»¥ä¸‹æ˜¯å®ƒçš„æ ¸å¿ƒåŠŸèƒ½å’Œç”¨é€”æ€»ç»“ï¼š

---

### ğŸ” æ’ä»¶åŠŸèƒ½æ¦‚è¿°

- **èº«ä»½éªŒè¯æµ‹è¯•**ï¼šç”¨äºéªŒè¯å®¢æˆ·ç«¯æäº¤çš„å‡­æ®ï¼ˆå¦‚å¯†ç ï¼‰æ˜¯å¦ä¸æœåŠ¡å™¨ä¸Šå­˜å‚¨çš„åŒ¹é…ã€‚
- **æ—¥å¿—è®°å½•**ï¼šå°†èº«ä»½éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„ç»“æœè®°å½•åˆ°æœåŠ¡å™¨é”™è¯¯æ—¥å¿—ä¸­ï¼Œä¾¿äºè°ƒè¯•å’Œå®¡æŸ¥ã€‚
- **æ’ä»¶ç»“æ„æ¼”ç¤º**ï¼šå±•ç¤ºå¦‚ä½•å°†èº«ä»½éªŒè¯é€»è¾‘å°è£…ä¸ºå¯åŠ è½½æ’ä»¶ï¼Œé€‚åˆä½œä¸ºå¼€å‘è‡ªå®šä¹‰æ’ä»¶çš„èµ·ç‚¹ã€‚

---

### âš™ï¸ æ’ä»¶ç»„æˆ

|ç»„ä»¶ç±»å‹|åç§°|è¯´æ˜|
|---|---|---|
|æœåŠ¡å™¨ç«¯æ’ä»¶|`test_plugin_server`|å®ç°èº«ä»½éªŒè¯é€»è¾‘|
|å®¢æˆ·ç«¯æ’ä»¶|`auth_test_plugin`|æä¾›å®¢æˆ·ç«¯å‡­æ®|
|åŠ¨æ€åº“æ–‡ä»¶|`auth_test_plugin.so`|æ’ä»¶çš„å…±äº«åº“æ–‡ä»¶|

---

### ğŸ§ª ä½¿ç”¨åœºæ™¯ä¸é™åˆ¶

- **ç”¨é€”**ï¼š
    - æ•™å­¦ä¸å¼€å‘æµ‹è¯•
    - æ’ä»¶å¼€å‘çš„å‚è€ƒå®ç°
- **ä¸é€‚ç”¨åœºæ™¯**ï¼š
    - ç”Ÿäº§ç¯å¢ƒ
    - å…¬ç½‘æš´éœ²çš„æœåŠ¡å™¨

---

### ğŸ› ï¸ å®‰è£…ä¸ä½¿ç”¨ç¤ºä¾‹

1. **å®‰è£…æ’ä»¶**ï¼š
    
    ```sql
    INSTALL PLUGIN test_plugin_server SONAME 'auth_test_plugin.so';
    ```
    
2. **åˆ›å»ºæµ‹è¯•ç”¨æˆ·**ï¼š
    
    ```sql
    CREATE USER 'testuser'@'localhost' IDENTIFIED WITH test_plugin_server BY 'testpassword';
    CREATE USER 'testpassword'@'localhost';
    GRANT PROXY ON 'testpassword'@'localhost' TO 'testuser'@'localhost';
    ```
    
3. **è¿æ¥æµ‹è¯•**ï¼š
    
    ```bash
    mysql --user=testuser --password
    ```
    
4. **éªŒè¯æ’ä»¶çŠ¶æ€**ï¼š
    
    ```sql
    SELECT PLUGIN_NAME, PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME LIKE '%test_plugin%';
    ```
    

---

### ğŸ“Œ æ³¨æ„äº‹é¡¹

- æ’ä»¶å¿…é¡»é¢„å…ˆå®‰è£…å¹¶ä½äº `plugin_dir` æŒ‡å®šçš„ç›®å½•ä¸­ã€‚
- æ’ä»¶ä»…ç”¨äºæ¼”ç¤ºç›®çš„ï¼Œä¸å…·å¤‡åŠ å¯†æˆ–å®‰å…¨é˜²æŠ¤æœºåˆ¶ã€‚
- æ’ä»¶ä¼šå°†å¯†ç æ˜æ–‡ä¸ `mysql.user` è¡¨ä¸­çš„ `authentication_string` å­—æ®µè¿›è¡Œæ¯”å¯¹ã€‚
- MySQL çš„ `test_plugin_server` æ’ä»¶**åªå…è®¸ MySQL ç”¨æˆ·é€šè¿‡ UNIX å¥—æ¥å­—ç™»å½•**ã€‚

ğŸ” è¿™æ˜¯å› ä¸ºè¯¥æ’ä»¶çš„è®¾è®¡åˆè¡·æ˜¯ç”¨äºæµ‹è¯•å’Œå¼€å‘ç¯å¢ƒï¼Œå®ƒå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **ä»…æ”¯æŒ UNIX å¥—æ¥å­—è¿æ¥**ï¼šä¸æ”¯æŒ TCP/IP ç½‘ç»œè¿æ¥ï¼Œå› æ­¤åªèƒ½åœ¨æœ¬åœ°é€šè¿‡ `mysql.sock` æ–‡ä»¶è¿›è¡Œèº«ä»½éªŒè¯ã€‚
- **éªŒè¯æ“ä½œç³»ç»Ÿç”¨æˆ·å’Œç»„**ï¼šæ’ä»¶ä¼šå°†å°è¯•ç™»å½•çš„ MySQL ç”¨æˆ·æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿç”¨æˆ·è¿›è¡ŒéªŒè¯ã€‚
- **å‘é€æ˜æ–‡å¯†ç **ï¼šå®¢æˆ·ç«¯å°†å¯†ç ä»¥æ˜æ–‡å½¢å¼å‘é€åˆ°æœåŠ¡å™¨ï¼Œè¿™è¿›ä¸€æ­¥é™åˆ¶äº†å…¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ä½¿ç”¨ã€‚

### ğŸ“Œ æ€»ç»“

`test_plugin_server` æ˜¯ä¸€ä¸ªç”¨äºæ¼”ç¤ºå’Œæµ‹è¯•çš„æ’ä»¶ï¼Œ**ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ**ï¼Œå¹¶ä¸”**åªèƒ½é€šè¿‡æœ¬åœ° UNIX å¥—æ¥å­—è¿›è¡Œè¿æ¥**ï¼Œè¿™ä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªå®‰å…¨é™åˆ¶ã€‚

---

å¦‚éœ€æ·±å…¥äº†è§£æ’ä»¶çš„æºç ç»“æ„æˆ–æ‰©å±•æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒ [MySQL å®˜æ–¹æ–‡æ¡£](https://mysql.net.cn/doc/refman/8.0/en/test-pluggable-authentication.html)æˆ– [CSDN åšå®¢çš„è¯¦ç»†è§£æ](https://blog.csdn.net/weixin_44496870/article/details/131576627)ã€‚


## åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ¨èä½¿ç”¨å“ªäº›æ’ä»¶è¿›è¡Œèº«ä»½éªŒè¯ï¼Ÿ

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒMySQL æä¾›äº†å¤šç§èº«ä»½éªŒè¯æ’ä»¶ï¼Œä»¥ä¸‹æ˜¯å‡ ç§**æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ**çš„æ’ä»¶åŠå…¶ç‰¹ç‚¹ï¼š

---

### âœ… æ¨èçš„èº«ä»½éªŒè¯æ’ä»¶

| æ’ä»¶åç§°                    | åŠ å¯†æœºåˆ¶         | ç‰¹ç‚¹ä¸é€‚ç”¨åœºæ™¯                                |
| ----------------------- | ------------ | -------------------------------------- |
| `caching_sha2_password` | SHA-256 + ç¼“å­˜ | **MySQL 8.0 é»˜è®¤æ’ä»¶**ï¼Œå…¼é¡¾å®‰å…¨æ€§ä¸æ€§èƒ½ï¼Œé€‚åˆå¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒ  |
| `sha256_password`       | çº¯ SHA-256    | æ›´é«˜å®‰å…¨æ€§ï¼Œä½†æ€§èƒ½ç•¥ä½ï¼Œé€‚åˆå¯¹å®‰å…¨è¦æ±‚æé«˜çš„ç³»ç»Ÿ               |
| `mysql_native_password` | SHA-1        | å…¼å®¹æ€§å¥½ï¼Œé€‚ç”¨äºæ—§ç³»ç»Ÿï¼Œä½†å®‰å…¨æ€§è¾ƒä½ï¼Œ**ä¸æ¨èæ–°ç³»ç»Ÿä½¿ç”¨**        |
| `auth_socket`           | æ“ä½œç³»ç»Ÿç”¨æˆ·æ˜ å°„     | ä»…é™æœ¬åœ°è¿æ¥ï¼Œé€‚åˆ Linux ç³»ç»Ÿä¸­é€šè¿‡ UNIX å¥—æ¥å­—è¿›è¡Œèº«ä»½éªŒè¯   |
| `PAM`ï¼ˆä¼ä¸šç‰ˆï¼‰              | å¤–éƒ¨æ¨¡å—         | æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆå¦‚æŒ‡çº¹ã€ä»¤ç‰Œï¼‰ï¼Œé€‚åˆä¼ä¸šç»Ÿä¸€è®¤è¯ä½“ç³»            |
| `LDAP`ï¼ˆä¼ä¸šç‰ˆï¼‰             | LDAP åè®®      | é›†æˆä¼ä¸šç›®å½•æœåŠ¡ï¼ˆå¦‚ Active Directoryï¼‰ï¼Œé€‚åˆå¤§è§„æ¨¡ç”¨æˆ·ç®¡ç† |
| `Kerberos`ï¼ˆä¼ä¸šç‰ˆï¼‰         | Kerberos åè®®  | é«˜å®‰å…¨æ€§ï¼Œé€‚åˆæ”¿åºœã€é‡‘èç­‰å¯¹èº«ä»½éªŒè¯è¦æ±‚æé«˜çš„åœºæ™¯              |
| `FIDO`ï¼ˆä¼ä¸šç‰ˆï¼‰             | ç”Ÿç‰©è¯†åˆ«/ç¡¬ä»¶å¯†é’¥    | æ”¯æŒæ™ºèƒ½å¡ã€æŒ‡çº¹ã€é¢éƒ¨è¯†åˆ«ç­‰ï¼Œé€‚åˆé›¶ä¿¡ä»»æ¶æ„                 |

---

### ğŸ” æ’ä»¶é€‰æ‹©å»ºè®®

- **é€šç”¨ç”Ÿäº§ç¯å¢ƒ**ï¼šæ¨èä½¿ç”¨ `caching_sha2_password`ï¼Œå®ƒæ˜¯ MySQL 8.0 çš„é»˜è®¤æ’ä»¶ï¼Œå…¼é¡¾å®‰å…¨æ€§ä¸æ€§èƒ½ã€‚
- **é«˜å®‰å…¨æ€§è¦æ±‚**ï¼šä½¿ç”¨ `sha256_password` æˆ–ä¼ä¸šç‰ˆçš„ `FIDO`ã€`Kerberos` æ’ä»¶ã€‚
- **æœ¬åœ°è‡ªåŠ¨ç™»å½•**ï¼šä½¿ç”¨ `auth_socket` æ’ä»¶ï¼Œé€‚åˆè‡ªåŠ¨åŒ–è„šæœ¬æˆ–ç³»ç»ŸæœåŠ¡ã€‚
- **ä¼ä¸šç»Ÿä¸€è®¤è¯**ï¼šä½¿ç”¨ `PAM` æˆ– `LDAP` æ’ä»¶ï¼ˆéœ€ MySQL Enterprise ç‰ˆæœ¬ï¼‰ã€‚

---

### ğŸ“Œ æ³¨æ„äº‹é¡¹

- é¿å…ä½¿ç”¨ `mysql_native_password` å’Œ `mysql_old_password`ï¼Œå› å…¶åŸºäº SHA-1 æˆ–æ›´å¼±ç®—æ³•ï¼Œå·²ä¸å†å®‰å…¨ã€‚
- ä¼ä¸šç‰ˆæ’ä»¶ï¼ˆå¦‚ PAMã€LDAPã€Kerberosã€FIDOï¼‰éœ€è´­ä¹° MySQL Enterprise Editionã€‚
- æ’ä»¶éœ€åœ¨åˆ›å»ºç”¨æˆ·æ—¶æ˜¾å¼æŒ‡å®šï¼Œä¾‹å¦‚ï¼š
    
    ```sql
    CREATE USER 'user1'@'%' IDENTIFIED WITH caching_sha2_password BY 'StrongPassword!';
    ```
    

---

## `caching_sha2_password` æ’ä»¶çš„å·¥ä½œåŸç†

ä¸‹é¢æ˜¯å¯¹ **MySQL `caching_sha2_password` æ’ä»¶çš„å·¥ä½œåŸç†**çš„è¯¦ç»†è§£æï¼š

---

### ğŸ” æ’ä»¶ç®€ä»‹

`caching_sha2_password` æ˜¯ä» **MySQL 8.0.4** å¼€å§‹å¼•å…¥çš„é»˜è®¤èº«ä»½éªŒè¯æ’ä»¶ï¼Œæ—¨åœ¨æ›¿ä»£æ—§çš„ `mysql_native_password` æ’ä»¶ï¼Œæä¾›æ›´å¼ºçš„å®‰å…¨æ€§å’Œæ›´é«˜çš„æ€§èƒ½ã€‚

---

### âš™ï¸ å·¥ä½œåŸç†è¯¦è§£

#### 1. **å¯†ç å­˜å‚¨æœºåˆ¶**

- ä½¿ç”¨ **SHA-256** ç®—æ³•å¯¹å¯†ç è¿›è¡Œå¤šè½®åŠ å¯†ï¼ˆé»˜è®¤ 5000 æ¬¡ï¼‰ï¼›
- åŠ å…¥ **éšæœºç›å€¼ï¼ˆsaltï¼‰**ï¼Œå³ä½¿ä¸¤ä¸ªç”¨æˆ·ä½¿ç”¨ç›¸åŒå¯†ç ï¼Œæœ€ç»ˆçš„å“ˆå¸Œå€¼ä¹Ÿä¸åŒï¼›
- åŠ å¯†åçš„ç»“æœå­˜å‚¨åœ¨ `mysql.user` è¡¨çš„ `authentication_string` å­—æ®µä¸­ã€‚

#### 2. **èº«ä»½éªŒè¯æµç¨‹**

æ’ä»¶æ ¹æ®æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼Œåˆ†ä¸ºä¸¤ç§è®¤è¯è·¯å¾„ï¼š

##### âœ… å¿«é€Ÿè®¤è¯ï¼ˆå‘½ä¸­ç¼“å­˜ï¼‰

- æœåŠ¡å™¨ç¼“å­˜äº†ç”¨æˆ·çš„å“ˆå¸Œæ‘˜è¦ï¼›
- å®¢æˆ·ç«¯ç™»å½•æ—¶ï¼ŒæœåŠ¡å™¨ç›´æ¥æ¯”å¯¹ç¼“å­˜ï¼Œæ— éœ€å¯†ç äº¤æ¢ï¼›
- **ä¼˜ç‚¹**ï¼šé€Ÿåº¦å¿«ã€æ— éœ€åŠ å¯†è¿æ¥ã€‚

##### ğŸ” å®Œæ•´è®¤è¯ï¼ˆæœªå‘½ä¸­ç¼“å­˜ï¼‰

- æœåŠ¡å™¨æœªå‘½ä¸­ç¼“å­˜æˆ–ç¼“å­˜å¤±æ•ˆï¼›
- å®¢æˆ·ç«¯éœ€å‘é€åŠ å¯†åçš„å¯†ç ï¼›
- è‹¥æœªå¯ç”¨ SSLï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ **RSA å…¬é’¥åŠ å¯†å¯†ç **ï¼ŒæœåŠ¡å™¨ç”¨ç§é’¥è§£å¯†ï¼›
- **è¦æ±‚**ï¼šå¿…é¡»æ˜¯åŠ å¯†è¿æ¥ï¼ˆSSLï¼‰æˆ–å¯ç”¨ RSA å¯†é’¥äº¤æ¢ã€‚

> ğŸ“Œ ç¼“å­˜å¤±æ•ˆçš„æƒ…å†µåŒ…æ‹¬ï¼šå¯†ç å˜æ›´ã€æƒé™åˆ·æ–°ï¼ˆå¦‚ `FLUSH PRIVILEGES`ï¼‰ã€æœåŠ¡å™¨é‡å¯ç­‰ã€‚

---

### ğŸ§  å®‰å…¨ä¸æ€§èƒ½å…¼é¡¾

| ç‰¹æ€§       | æè¿°                                 |
| -------- | ---------------------------------- |
| **å®‰å…¨æ€§**  | ä½¿ç”¨ SHA-256 + ç› + å¤šè½®å“ˆå¸Œï¼Œé˜²æ­¢æš´åŠ›ç ´è§£å’Œå½©è™¹è¡¨æ”»å‡» |
| **æ€§èƒ½ä¼˜åŒ–** | ç¼“å­˜æœºåˆ¶é¿å…é¢‘ç¹åŠ å¯†è®¡ç®—å’Œå¯†é’¥äº¤æ¢                  |
| **å…¼å®¹æ€§**  | æ”¯æŒ SSL å’Œ RSA å…¬é’¥åŠ å¯†ï¼Œé€‚åº”ä¸åŒéƒ¨ç½²ç¯å¢ƒ         |
| **é»˜è®¤æ’ä»¶** | ä» MySQL 8.0.4 èµ·é»˜è®¤å¯ç”¨ï¼Œæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ       |

---

### ğŸ”§ é…ç½®å»ºè®®

- è‹¥ä½¿ç”¨éåŠ å¯†è¿æ¥ï¼Œéœ€å¯ç”¨ RSA å¯†é’¥äº¤æ¢ï¼š
    
    ```bash
    mysql --ssl-mode=DISABLED --get-server-public-key
    ```
    
- å¯é€šè¿‡ç³»ç»Ÿå˜é‡ `caching_sha2_password_digest_rounds` è®¾ç½®å“ˆå¸Œè½®æ•°ï¼ˆé»˜è®¤ 5000ï¼‰ï¼›
- è‹¥å®¢æˆ·ç«¯ä¸æ”¯æŒè¯¥æ’ä»¶ï¼Œå¯æ‰‹åŠ¨åˆ‡æ¢ä¸º `mysql_native_password`ï¼ˆä¸æ¨èï¼‰ï¼š
    
    ```sql
    ALTER USER 'user'@'host' IDENTIFIED WITH mysql_native_password BY 'password';
    ```
    

---

### ğŸ“š å»¶ä¼¸é˜…è¯»

- [MySQL å®˜æ–¹æ–‡æ¡£ï¼šcaching_sha2_password](https://dev.mysql.com/doc/refman/8.0/en/caching-sha2-pluggable-authentication.html)
- [æŠ€æœ¯è¯¦è§£æ–‡ç« ï¼ˆSegmentFaultï¼‰](https://segmentfault.com/a/1190000040733952)

---

## MySQLä¸­å…³äºroleçš„ä½œç”¨

åœ¨ **MySQL 8.0** ä¸­å¼•å…¥çš„ **Roleï¼ˆè§’è‰²ï¼‰åŠŸèƒ½** æ˜¯ä¸€ç§æƒé™ç®¡ç†æœºåˆ¶ï¼Œæ—¨åœ¨ç®€åŒ–å’Œé›†ä¸­ç®¡ç†ç”¨æˆ·æƒé™ã€‚ä»¥ä¸‹æ˜¯å¯¹å…¶åŠŸèƒ½çš„ç®€è¦æè¿°ï¼š

---

### ğŸ­ ä»€ä¹ˆæ˜¯ Roleï¼Ÿ

**Roleï¼ˆè§’è‰²ï¼‰** æ˜¯ä¸€ç»„æƒé™çš„é›†åˆï¼Œå¯ä»¥åƒç”¨æˆ·ä¸€æ ·è¢«æˆäºˆæƒé™ï¼Œç„¶åå†å°†è¿™ä¸ªè§’è‰²åˆ†é…ç»™ä¸€ä¸ªæˆ–å¤šä¸ªç”¨æˆ·ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š

- é¿å…é‡å¤æˆæƒ
- ç®€åŒ–æƒé™å˜æ›´
- æé«˜æƒé™ç®¡ç†çš„å¯ç»´æŠ¤æ€§å’Œå®‰å…¨æ€§

---

### ğŸ”§ Role çš„æ ¸å¿ƒåŠŸèƒ½

|åŠŸèƒ½|æè¿°|
|---|---|
|**åˆ›å»ºè§’è‰²**|ä½¿ç”¨ `CREATE ROLE` åˆ›å»ºä¸€ä¸ªé€»è¾‘è§’è‰²|
|**æˆäºˆæƒé™**|ä½¿ç”¨ `GRANT` å°†æƒé™æˆäºˆè§’è‰²|
|**åˆ†é…è§’è‰²**|ä½¿ç”¨ `GRANT role_name TO user` å°†è§’è‰²åˆ†é…ç»™ç”¨æˆ·|
|**æ¿€æ´»è§’è‰²**|ç”¨æˆ·ç™»å½•åéœ€ä½¿ç”¨ `SET ROLE` æ¿€æ´»è§’è‰²ï¼Œæˆ–è®¾ç½®é»˜è®¤è§’è‰²|
|**é›†ä¸­ç®¡ç†**|ä¿®æ”¹è§’è‰²æƒé™ä¼šå½±å“æ‰€æœ‰æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·ï¼Œæ— éœ€é€ä¸ªä¿®æ”¹|

---

### ğŸ§ª ç¤ºä¾‹

```sql
-- åˆ›å»ºè§’è‰²
CREATE ROLE 'report_reader';

-- ç»™è§’è‰²æˆäºˆæƒé™
GRANT SELECT ON reports.* TO 'report_reader';

-- åˆ›å»ºç”¨æˆ·å¹¶åˆ†é…è§’è‰²
CREATE USER 'alice'@'%' IDENTIFIED BY 'password';
GRANT 'report_reader' TO 'alice'@'%';

-- è®¾ç½®é»˜è®¤è§’è‰²
SET DEFAULT ROLE 'report_reader' TO 'alice'@'%';
```

---

### âš ï¸ æ³¨æ„äº‹é¡¹

- é»˜è®¤æƒ…å†µä¸‹ï¼Œè§’è‰²ä¸ä¼šè‡ªåŠ¨æ¿€æ´»ã€‚å¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå˜é‡ `activate_all_roles_on_login = ON` å®ç°è‡ªåŠ¨æ¿€æ´»ã€‚
- è§’è‰²æœ¬èº«ä¸èƒ½ç™»å½•æ•°æ®åº“ï¼Œå®ƒåªæ˜¯æƒé™çš„å®¹å™¨ã€‚

---

### ğŸ“š å»¶ä¼¸é˜…è¯»

å¯ä»¥æŸ¥çœ‹è¿™ç¯‡[çŸ¥ä¹ä¸“æ æ–‡ç« ](https://zhuanlan.zhihu.com/p/367873840)æˆ–[åšå®¢å›­æŠ€æœ¯è§£æ](https://www.cnblogs.com/mysqljs/p/14703415.html)ï¼Œäº†è§£æ›´å¤šä½¿ç”¨æŠ€å·§å’Œæœ€ä½³å®è·µã€‚


## åœ¨MySQLä¸­æ¿€æ´»è§’è‰²(role)åˆ°å½“å‰ä¼šè¯

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```sql
SET ROLE role_name;
```

---

### âœ… å¸¸è§ç”¨æ³•

|å‘½ä»¤|è¯´æ˜|
|---|---|
|`SET ROLE 'role1';`|æ¿€æ´»æŒ‡å®šè§’è‰²|
|`SET ROLE 'role1', 'role2';`|åŒæ—¶æ¿€æ´»å¤šä¸ªè§’è‰²|
|`SET ROLE DEFAULT;`|æ¿€æ´»ç”¨æˆ·çš„é»˜è®¤è§’è‰²|
|`SET ROLE ALL;`|æ¿€æ´»è¯¥ç”¨æˆ·è¢«æˆäºˆçš„æ‰€æœ‰è§’è‰²|
|`SET ROLE NONE;`|ç¦ç”¨å½“å‰ä¼šè¯ä¸­çš„æ‰€æœ‰è§’è‰²|
|`SET ROLE ALL EXCEPT 'role1';`|æ¿€æ´»é™¤æŒ‡å®šè§’è‰²å¤–çš„æ‰€æœ‰è§’è‰²|

> ğŸ“Œ æ³¨æ„ï¼šåªæœ‰ç”¨æˆ·å·²è¢«æˆäºˆçš„è§’è‰²æ‰èƒ½è¢«æ¿€æ´»ã€‚

---

### ğŸ” æŸ¥çœ‹å½“å‰ä¼šè¯æ¿€æ´»çš„è§’è‰²

```sql
SELECT CURRENT_ROLE();
```

---

### ğŸ“š ç¤ºä¾‹

```sql
-- æ¿€æ´»å•ä¸ªè§’è‰²
SET ROLE 'report_reader';

-- æ¿€æ´»å¤šä¸ªè§’è‰²
SET ROLE 'report_reader', 'data_editor';

-- ç¦ç”¨æ‰€æœ‰è§’è‰²
SET ROLE NONE;

-- æ¿€æ´»é»˜è®¤è§’è‰²
SET ROLE DEFAULT;
```

---

ğŸ”— å‚è€ƒèµ„æ–™ï¼š

- [è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒºï¼šMySQLè§’è‰²æ¿€æ´»è¯¦è§£](https://cloud.tencent.com/developer/article/2320657)
- [åšå®¢å›­ï¼šMySQLè§’è‰²ç®¡ç†è¯­æ³•](https://www.cnblogs.com/zmc60/p/17035589.html)


## å¦‚ä½•è®¾ç½®ç™»å½•æ—¶è‡ªåŠ¨æ¿€æ´»è§’è‰²

åœ¨ MySQL ä¸­ï¼Œç”¨æˆ·ç™»å½•åé»˜è®¤ä¸ä¼šè‡ªåŠ¨æ¿€æ´»æ‰€æœ‰è§’è‰²ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å®ç°è‡ªåŠ¨æ¿€æ´»ï¼š

---

### âœ… æ–¹æ³•ä¸€ï¼šè®¾ç½®é»˜è®¤è§’è‰²

ä½¿ç”¨ `SET DEFAULT ROLE` å‘½ä»¤ä¸ºç”¨æˆ·æŒ‡å®šé»˜è®¤æ¿€æ´»çš„è§’è‰²ï¼š

```sql
-- ä¸ºç”¨æˆ·è®¾ç½®é»˜è®¤è§’è‰²
SET DEFAULT ROLE 'role1', 'role2' TO 'username'@'host';
```

ğŸ“Œ ç¤ºä¾‹ï¼š

```sql
SET DEFAULT ROLE 'report_reader' TO 'alice'@'%';
```

è¿™æ ·ï¼Œ`alice` ç”¨æˆ·æ¯æ¬¡ç™»å½•æ—¶ï¼Œ`report_reader` è§’è‰²ä¼šè‡ªåŠ¨æ¿€æ´»ã€‚

---

### âœ… æ–¹æ³•äºŒï¼šå¯ç”¨ç³»ç»Ÿå˜é‡ `activate_all_roles_on_login`

å¦‚æœä½ å¸Œæœ›æ‰€æœ‰è¢«æˆäºˆçš„è§’è‰²åœ¨ç”¨æˆ·ç™»å½•æ—¶**å…¨éƒ¨è‡ªåŠ¨æ¿€æ´»**ï¼Œå¯ä»¥è®¾ç½®ä»¥ä¸‹ç³»ç»Ÿå˜é‡ï¼š

```sql
SET GLOBAL activate_all_roles_on_login = ON;
```

> âš ï¸ æ³¨æ„ï¼š
> 
> - è¯¥å˜é‡æ˜¯å…¨å±€å˜é‡ï¼Œéœ€æœ‰ `SUPER` æƒé™ï¼›
> - è¯¥è®¾ç½®å¯¹æ‰€æœ‰ç”¨æˆ·ç”Ÿæ•ˆï¼›
> - è¯¥å˜é‡ä¸ä¼šæŒä¹…åŒ–ï¼Œé‡å¯åéœ€é‡æ–°è®¾ç½®ï¼Œæˆ–å†™å…¥é…ç½®æ–‡ä»¶ã€‚

---

### ğŸ” æŸ¥çœ‹å½“å‰é»˜è®¤è§’è‰²

```sql
SELECT DEFAULT_ROLE_USER, DEFAULT_ROLE_HOST, DEFAULT_ROLE FROM mysql.default_roles;
```

---

### ğŸ§  å°ç»“

|æ–¹å¼|é€‚ç”¨åœºæ™¯|æ˜¯å¦å…¨å±€|
|---|---|---|
|`SET DEFAULT ROLE`|ç²¾ç»†æ§åˆ¶æ¯ä¸ªç”¨æˆ·çš„é»˜è®¤è§’è‰²|å¦|
|`activate_all_roles_on_login`|æ‰€æœ‰ç”¨æˆ·è‡ªåŠ¨æ¿€æ´»å…¨éƒ¨è§’è‰²|æ˜¯|

---


## ç®€å•è§„åˆ’ä¸‹è§’è‰²ç»“æ„ï¼Œæ¯”å¦‚â€œåªè¯»ç”¨æˆ·â€ã€â€œå¼€å‘è€…â€ã€â€œDBAâ€ç­‰è§’è‰²çš„æƒé™åˆ†é…

==ä¸‹é¢æ˜¯ä¸€ä¸ªé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ **MySQL è§’è‰²æƒé™æ¨¡å‹è‰å›¾**ï¼Œé€‚åˆä¸­å°å‹ä¼ä¸šæˆ–å¼€å‘å›¢é˜Ÿä½¿ç”¨ï¼š==

---

### ğŸ§© è§’è‰²è®¾è®¡è‰å›¾

|è§’è‰²åç§°|æè¿°|æˆæƒç¤ºä¾‹|
|---|---|---|
|`read_only`|åªè¯»ç”¨æˆ·ï¼Œé€‚åˆå®¡è®¡æˆ–BIå·¥å…·|`SELECT` æƒé™|
|`developer`|å¼€å‘äººå‘˜ï¼Œå…·å¤‡è¯»å†™æƒé™|`SELECT`, `INSERT`, `UPDATE`, `DELETE`|
|`dba`|æ•°æ®åº“ç®¡ç†å‘˜ï¼Œå…·å¤‡DDLæƒé™|æ‰€æœ‰ DML + `CREATE`, `ALTER`, `DROP`|
|`replication`|å¤åˆ¶è´¦å·ï¼Œé€‚ç”¨äºä¸»ä»å¤åˆ¶|`REPLICATION SLAVE`, `REPLICATION CLIENT`|
|`backup_operator`|å¤‡ä»½è´¦å·ï¼Œä»…èƒ½å¯¼å‡ºæ•°æ®|`SELECT`, `LOCK TABLES`, `SHOW VIEW`|
|`admin`|è¶…çº§ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™|`ALL PRIVILEGES`|

---

### ğŸ› ï¸ SQL ç¤ºä¾‹

```sql
-- åˆ›å»ºè§’è‰²
CREATE ROLE 'read_only', 'developer', 'dba', 'replication', 'backup_operator', 'admin';

-- æˆæƒè§’è‰²æƒé™
GRANT SELECT ON mydb.* TO 'read_only';
GRANT SELECT, INSERT, UPDATE, DELETE ON mydb.* TO 'developer';
GRANT ALL PRIVILEGES ON mydb.* TO 'dba';
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'replication';
GRANT SELECT, LOCK TABLES, SHOW VIEW ON mydb.* TO 'backup_operator';
GRANT ALL PRIVILEGES ON *.* TO 'admin' WITH GRANT OPTION;

-- åˆ›å»ºç”¨æˆ·å¹¶åˆ†é…è§’è‰²
CREATE USER 'alice'@'%' IDENTIFIED BY 'securepass';
GRANT 'developer' TO 'alice'@'%';
SET DEFAULT ROLE 'developer' TO 'alice'@'%';
```

---

### ğŸ” å®‰å…¨å»ºè®®

- ä½¿ç”¨ `SET DEFAULT ROLE` è®¾ç½®é»˜è®¤è§’è‰²ï¼Œé¿å…ç”¨æˆ·ç™»å½•åå¿˜è®°æ¿€æ´»ï¼›
- å¯¹äºæ•æ„Ÿæ“ä½œï¼ˆå¦‚ `DROP`ã€`GRANT`ï¼‰ï¼Œä»…æˆäºˆ `admin`ï¼›
- ä½¿ç”¨ `REVOKE` å’Œ `SHOW GRANTS` å®šæœŸå®¡æŸ¥æƒé™ï¼›
- é…åˆ `audit_log` æ’ä»¶è®°å½•ç”¨æˆ·è¡Œä¸ºã€‚

---

## ç¦ç”¨è´¦æˆ·çš„è‡ªåŠ¨å¯†ç è¿‡æœŸ

åœ¨ MySQL ä¸­ï¼Œ**ç¦ç”¨è´¦æˆ·çš„è‡ªåŠ¨å¯†ç è¿‡æœŸ**å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å®ç°ï¼Œåˆ†åˆ«é€‚ç”¨äº**å…¨å±€è®¾ç½®**å’Œ**å•ä¸ªç”¨æˆ·è®¾ç½®**ï¼š

---

### âœ… æ–¹æ³•ä¸€ï¼šå…¨å±€ç¦ç”¨å¯†ç è¿‡æœŸç­–ç•¥

è®¾ç½®å…¨å±€å˜é‡ `default_password_lifetime` ä¸º `0` æˆ– `-1`ï¼Œè¡¨ç¤ºå¯†ç æ°¸ä¸è¿‡æœŸï¼š

```sql
SET GLOBAL default_password_lifetime = 0;
```

> ğŸ“Œ è¯´æ˜ï¼š
> 
> - è¯¥è®¾ç½®ä¼šå½±å“æ‰€æœ‰æœªå•ç‹¬è®¾ç½®è¿‡æœŸç­–ç•¥çš„ç”¨æˆ·ï¼›
> - è‹¥è¦æ°¸ä¹…ç”Ÿæ•ˆï¼Œåº”å°†å…¶å†™å…¥ MySQL é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `my.cnf`ï¼‰ï¼š
>     
>     ```ini
>     [mysqld]
>     default_password_lifetime = 0
>     ```
>     

---

### âœ… æ–¹æ³•äºŒï¼šä¸ºæŒ‡å®šç”¨æˆ·ç¦ç”¨å¯†ç è¿‡æœŸ

ä½¿ç”¨ `ALTER USER` å‘½ä»¤ä¸ºæŸä¸ªç”¨æˆ·è®¾ç½®å¯†ç æ°¸ä¸è¿‡æœŸï¼š

```sql
ALTER USER 'username'@'host' PASSWORD EXPIRE NEVER;
```

ğŸ“Œ ç¤ºä¾‹ï¼š

```sql
ALTER USER 'alice'@'localhost' PASSWORD EXPIRE NEVER;
```

> è¿™ä¼šè¦†ç›–å…¨å±€ç­–ç•¥ï¼Œä½¿è¯¥ç”¨æˆ·çš„å¯†ç æ°¸ä¸è¿‡æœŸã€‚

---

### ğŸ” æŸ¥çœ‹å½“å‰è®¾ç½®

- æŸ¥çœ‹å…¨å±€å¯†ç è¿‡æœŸç­–ç•¥ï¼š
    
    ```sql
    SHOW VARIABLES LIKE 'default_password_lifetime';
    ```
    
- æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦è®¾ç½®äº†å¯†ç è¿‡æœŸï¼š
    
    ```sql
    SELECT user, host, password_expired FROM mysql.user;
    ```
    

---

### ğŸ“š å‚è€ƒèµ„æ–™

- [æŠ€æœ¯åˆ†äº«ï¼šMySQL å¯†ç è¿‡æœŸæœºåˆ¶è¯¦è§£](https://segmentfault.com/a/1190000040001857)
- [CSDNï¼šMySQL å–æ¶ˆå¯†ç è¿‡æœŸè®¾ç½®](https://blog.csdn.net/LongtengGensSupreme/article/details/135460959)

---



