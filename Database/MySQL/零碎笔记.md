---
title: MySQL的临时笔记
author:
  - 守一
created: 2025-07-04
description: 关于MySQL的零碎问题笔记
tags:
  - mysql
---

## 下面这些MySQL参数中哪些是同时具有全局和会话作用域？
max_join_size、error_count、innodb_buffer_pool_size、sort_buffer_size、max_connections

以下是上述参数中是否具有 **全局（GLOBAL）** 和 **会话（SESSION）** 作用域的详细对比：

---

### ✅ 参数作用域对比表

| 参数名称                  | GLOBAL 作用域 | SESSION 作用域 | 说明 |
|---------------------------|----------------|-----------------|------|
| `max_join_size`           | ✅ 支持        | ✅ 支持          | 可用于限制单个查询可处理的最大行数 |
| `error_count`             | ❌ 不支持      | ✅ 支持          | 只读变量，仅在当前会话中有效 |
| `innodb_buffer_pool_size` | ✅ 支持        | ❌ 不支持        | 仅支持全局设置，且为静态参数，需重启生效 |
| `sort_buffer_size`        | ✅ 支持        | ✅ 支持          | 每个会话独立分配，可动态设置 |
| `max_connections`         | ✅ 支持        | ❌ 不支持        | 仅支持全局设置，用于控制最大连接数 |

---

### 📌 总结

具有 **同时支持 GLOBAL 和 SESSION 作用域** 的参数是：

- ✅ `max_join_size`
- ✅ `sort_buffer_size`

---

### 🔍 说明补充

- `error_count` 是一个只读的会话级状态变量，用于表示当前会话中执行语句产生的错误数。
- `innodb_buffer_pool_size` 是 InnoDB 的核心内存参数，只能全局设置，且通常需要在配置文件中设置并重启 MySQL。
- `max_connections` 是控制整个服务器最大连接数的参数，仅能全局设置。

---

## 上述参数的调优建议或适用场景

下面是这几个 MySQL 参数的详细调优建议和适用场景分析：

---

### 1. 🔍 `max_join_size`

- **作用**：限制单个查询可以处理的最大行数，防止意外的大型连接操作导致服务器资源耗尽。
- **适用场景**：
  - 防止开发或用户执行“笛卡尔积”式的大查询。
  - 多用于共享数据库环境或线上系统。
- **调优建议**：
  - 默认值为 `18446744073709551615`（无限制），可以根据业务需求设置为几百万行。
  - 可为特定用户会话设置较小值以限制资源使用：
    ```sql
    SET SESSION max_join_size = 1000000;
    ```

---

### 2. 🧮 `error_count`

- **作用**：记录当前会话中最近执行语句产生的错误数量。
- **适用场景**：
  - 用于调试或脚本中判断是否有错误发生。
- **调优建议**：
  - 只读变量，无需调优。
  - 可结合 `SHOW WARNINGS` 或 `SHOW ERRORS` 使用。

---

### 3. 🧠 `innodb_buffer_pool_size`

- **作用**：InnoDB 的核心内存缓存区，用于缓存数据页和索引页。
- **适用场景**：
  - 所有使用 InnoDB 的数据库系统，尤其是读写频繁的 OLTP 系统。
- **调优建议**：
  - 设置为物理内存的 60%–80%（专用数据库服务器）。
  - 示例配置（在 `my.cnf` 中）：
```ini
    innodb_buffer_pool_size = 8G
```
  - 对于大型系统，可结合 `innodb_buffer_pool_instances` 拆分缓冲池以提升并发性能。

---

### 4. 🧹 `sort_buffer_size`

- **作用**：每个线程用于排序操作的内存缓冲区大小。
- **适用场景**：
  - 查询中包含 `ORDER BY`、`GROUP BY`、`DISTINCT` 等操作。
- **调优建议**：
  - 默认值较小（如 256KB），可根据排序字段数量和数据量适当增大。
  - 但注意：这是**每个连接**分配的内存，设置过大可能导致内存耗尽。
```sql
    SET SESSION sort_buffer_size = 2 * 1024 * 1024;  -- 2MB
```

---

### 5. 👥 `max_connections`

- **作用**：控制允许同时连接到 MySQL 的最大客户端数量。
- **适用场景**：
  - 高并发 Web 应用、API 服务等。
- **调优建议**：
  - 根据服务器资源和连接池策略设置，常见值如 200、500、1000。
  - 设置过高可能导致系统资源耗尽（如文件描述符、内存）。
```sql
    SET GLOBAL max_connections = 500;
```
  - 配合 `wait_timeout` 和 `max_connect_errors` 控制连接行为。

---

### ✅ 总结建议

| 参数名                       | 建议用途         | 调优重点            |
| ------------------------- | ------------ | --------------- |
| `max_join_size`           | 控制大查询        | 限制单个查询行数，防止误操作  |
| `error_count`             | 会话错误监控       | 无需调优            |
| `innodb_buffer_pool_size` | 提升 InnoDB 性能 | 设置为物理内存的 60–80% |
| `sort_buffer_size`        | 提升排序性能       | 控制每连接内存使用       |
| `max_connections`         | 控制并发连接数      | 根据业务并发量和资源合理设置  |

---


## innodb引擎是否支持T-tree索引

InnoDB 存储引擎 **不支持 T-tree 索引**。它使用的是 **B+ Tree（B+ 树）索引结构**，这是关系型数据库中最常见、最有效的索引方式之一。

---

### 🌳 InnoDB 支持的索引类型

| 索引类型       | 是否支持 | 说明 |
|----------------|----------|------|
| B+ Tree 索引   | ✅ 支持   | 默认索引结构，适用于主键和二级索引 |
| Fulltext 索引  | ✅ 支持（MySQL 5.6+） | 用于全文搜索 |
| Spatial 索引   | ✅ 支持（MySQL 5.7+） | 用于地理空间数据 |
| Hash 索引      | ❌ 不直接支持（但内部可能用于自适应哈希） |
| T-tree 索引    | ❌ 不支持 | T-tree 是某些内存数据库（如 Oracle TimesTen）使用的结构 |

---

### ❓什么是 T-tree？

T-tree（平衡三叉树）是一种为**内存数据库优化**的索引结构，结合了 AVL 树和 B-tree 的特性，旨在减少内存访问次数。它常用于：

- Oracle TimesTen
- SAP HANA（部分场景）
- 其他内存优化型数据库

但它**不适合磁盘型数据库**，因此 MySQL/InnoDB 并未采用。

---

### ✅ 总结

- InnoDB 使用 **B+ Tree** 作为其主要索引结构。
- **不支持 T-tree 索引**，因为它不是为磁盘型数据库设计的。


根据 MySQL 官方文档和配置文件规范，以下是 **server-specific groups**（服务器专用组）在 `my.cnf` 配置文件中的正确选项：

---

## 在my.cnf文件中有哪些是**server-specific groups**（服务器专用组）
### ✅ 正确答案：

- **[mysqld]**：用于配置 `mysqld` 服务器守护进程的选项（最常用的服务器组）
- **[server]**：通用服务器组，`mysqld` 和其他嵌入式服务器程序也会读取
- **[mysqld_safe]**：用于配置 `mysqld_safe` 启动脚本的选项

---

### ❌ 非服务器专用组（用于客户端或特定工具）：

- **[client]**：适用于所有客户端程序（如 `mysql`, `mysqladmin`, `mysqldump` 等），但不被服务器读取
- **[mysql]**：仅适用于 `mysql` 命令行客户端
- **[mysqldump]**：仅适用于 `mysqldump` 工具

---

### 📌 总结表格

| 组名           | 类型             | 说明 |
|----------------|------------------|------|
| `[mysqld]`      | ✅ 服务器专用     | 主服务器进程配置 |
| `[server]`      | ✅ 服务器专用     | 所有服务器程序通用配置 |
| `[mysqld_safe]` | ✅ 服务器专用     | 启动脚本配置 |
| `[client]`      | ❌ 客户端通用     | 所有客户端程序读取 |
| `[mysql]`       | ❌ 客户端专用     | 仅 `mysql` 命令行工具读取 |
| `[mysqldump]`   | ❌ 客户端专用     | 仅 `mysqldump` 工具读取 |

---

可以在 [MySQL 官方文档](https://dev.mysql.com/doc/refman/8.0/en/option-files.html) 中查看更多关于配置文件的分组说明。

## Performance Schema 有什么功能？

Performance Schema 是 MySQL 提供的一个强大性能监控与诊断工具，它的功能远不止分析查询和 I/O 等待。以下是它的 **其他核心功能**：

---

### 1. **细粒度性能监控**
- 能监控从 SQL 查询到内部线程、事件、锁等多个层级的性能指标。
- 支持查看语句执行时间、等待事件、资源使用等详细信息。

### 2. **低开销设计**
- 虽然会引入一定系统开销，但设计目标是尽量降低对数据库性能的影响。
- 可按需启用或禁用不同的监控模块，灵活控制资源消耗。

### 3. **高度可配置**
- 可通过 `setup_instruments`、`setup_consumers` 等表启用/禁用特定监控项。
- 支持动态调整采样频率、数据存储位置等参数。

### 4. **内存使用监控**
- 提供 `memory_summary_global_by_event_name` 等表，分析内存使用热点。
- 可识别内存泄漏或异常增长的模块。

### 5. **锁等待分析**
- 通过 `events_waits_current` 和 `events_waits_summary_by_instance` 表，分析锁争用情况。
- 有助于优化并发性能和事务设计。

### 6. **文件与磁盘 I/O 监控**
- 监控文件读写次数、耗时、文件路径等，识别 I/O 瓶颈。
- 表如 `file_summary_by_instance` 提供详细统计。

### 7. **线程与会话分析**
- 可查看当前活跃线程、连接状态、执行语句等。
- 支持分析慢连接、空闲连接等问题。

### 8. **结合 sys schema 简化使用**
- `sys` schema 提供了基于 Performance Schema 的视图，简化查询。
- 如 `sys.host_summary_by_statement_latency` 可快速查看主机执行效率。

---

### 📘 推荐阅读资源

| 📄 文章标题 | 简介 | 链接 |
|------------|------|------|
| MySQL 性能调优必知：Performance Schema 引擎的配置与使用 | 深入讲解 Performance Schema 的配置、使用场景与优化技巧 | [阅读文章](https://www.cnblogs.com/xiaoxi-jinchen/p/17137240.html) |
| MySQL Performance Schema 详解及运行时配置优化 | 介绍运行时如何灵活调整监控内容，适应高并发场景 | [阅读文章](https://www.cnblogs.com/bu-huo/p/18597105.html) |
| Performance Schema 性能监控组件详解 | 结构、数据流、典型使用场景全面解析 | [阅读文章](https://blog.csdn.net/exlink2012/article/details/146143716) |

## 通用查询日志的作用
根据如下选项分析：
A.To record all statements executed against all tables
B.To record the time and type of each connection and the process ID of all operations
C.To discover queries with excessive execution time.
D.To record statements where execution time exceeds a specified threshold
E.To include update operations stored as row-based binary logs on slave servers

根据对 MySQL 官方文档和技术社区的分析，**General Query Log（通用查询日志）** 的主要用途如下：

---

### ✅ 正确答案（选择两个）

#### ✅ A. **记录对所有表执行的所有语句**
- General Query Log 会记录所有客户端发送到 MySQL 服务器的 SQL 语句，无论是否执行成功。
- 包括 `SELECT`、`INSERT`、`UPDATE`、`DELETE` 等所有类型的语句。

#### ✅ B. **记录每个连接的时间、类型和操作的进程 ID**
- 日志中会记录每个客户端连接的开始和结束时间、连接类型（如 TCP/IP、本地 socket）、线程 ID 等信息。
- 这对于审计和排查连接问题非常有用。

---

### ❌ 错误选项解析

#### ❌ C. 发现执行时间过长的查询  
这是 **慢查询日志（Slow Query Log）** 的功能，而不是 General Query Log 的职责。

#### ❌ D. 记录执行时间超过指定阈值的语句  
同样属于 **慢查询日志** 的功能，General Query Log 不会根据执行时间筛选记录。

#### ❌ E. 包含从服务器上以行格式存储的更新操作  
这是 **二进制日志（Binary Log）** 的功能，尤其是用于主从复制的场景，与 General Query Log 无关。

---

### 📌 总结

| 功能 | 是否属于 General Query Log |
|------|-----------------------------|
| 记录所有 SQL 语句 | ✅ 是 |
| 记录连接信息 | ✅ 是 |
| 记录慢查询 | ❌ 否（属于慢查询日志） |
| 记录执行时间阈值 | ❌ 否 |
| 记录主从复制更新 | ❌ 否（属于二进制日志） |

## MySQL Performance Schema 中哪些工具没有子组件？
根据以下选项分析：
error
stage
statement
transaction
memory
idle

根据对 MySQL Performance Schema 的结构分析，以下 **三种 instruments（检测点）没有子组件（subcomponents）**，即它们是顶层事件类型，不再细分为更小的子类：

---

### ✅ 正确答案（选择三个）

#### 1. ✅ **error**
- 用于记录错误事件，如 SQL 执行错误、连接失败等。
- 是独立的事件类型，没有进一步的子分类。

#### 2. ✅ **transaction**
- 用于监控事务的开始、提交、回滚等操作。
- 是一个完整的逻辑单元，不再细分为子事件。

#### 3. ✅ **idle**
- 表示线程处于空闲状态（如等待客户端请求）。
- 是一种特殊的状态事件，没有子组件。

---

### ❌ 错误选项解析

| 选项 | 是否有子组件 | 说明 |
|------|--------------|------|
| ❌ **stage** | 有 | 如 `stage/sql/Sorting result`、`stage/sql/Sending data` 等，表示 SQL 执行过程的不同阶段。 |
| ❌ **statement** | 有 | 如 `statement/sql/select`、`statement/sql/insert` 等，表示不同类型的 SQL 语句。 |
| ❌ **memory** | 有 | 如 `memory/sql/THD::mem_root`、`memory/innodb/buf_buf_pool` 等，表示不同模块的内存使用。 |

---

### 📘 拓展阅读推荐

你可以参考这篇文章深入了解 Performance Schema 的 instrument 分类与结构：[MySQL中的Performance Schema性能监控组件](https://blog.csdn.net/exlink2012/article/details/146143716)。


## 关于MySQL的test_plugin_server插件的功能

MySQL 的 `test_plugin_server` 插件是一个用于测试和演示的可插拔身份验证插件，主要用于开发者学习如何编写自定义身份验证插件。以下是它的核心功能和用途总结：

---

### 🔍 插件功能概述

- **身份验证测试**：用于验证客户端提交的凭据（如密码）是否与服务器上存储的匹配。
- **日志记录**：将身份验证成功或失败的结果记录到服务器错误日志中，便于调试和审查。
- **插件结构演示**：展示如何将身份验证逻辑封装为可加载插件，适合作为开发自定义插件的起点。

---

### ⚙️ 插件组成

|组件类型|名称|说明|
|---|---|---|
|服务器端插件|`test_plugin_server`|实现身份验证逻辑|
|客户端插件|`auth_test_plugin`|提供客户端凭据|
|动态库文件|`auth_test_plugin.so`|插件的共享库文件|

---

### 🧪 使用场景与限制

- **用途**：
    - 教学与开发测试
    - 插件开发的参考实现
- **不适用场景**：
    - 生产环境
    - 公网暴露的服务器

---

### 🛠️ 安装与使用示例

1. **安装插件**：
    
    ```sql
    INSTALL PLUGIN test_plugin_server SONAME 'auth_test_plugin.so';
    ```
    
2. **创建测试用户**：
    
    ```sql
    CREATE USER 'testuser'@'localhost' IDENTIFIED WITH test_plugin_server BY 'testpassword';
    CREATE USER 'testpassword'@'localhost';
    GRANT PROXY ON 'testpassword'@'localhost' TO 'testuser'@'localhost';
    ```
    
3. **连接测试**：
    
    ```bash
    mysql --user=testuser --password
    ```
    
4. **验证插件状态**：
    
    ```sql
    SELECT PLUGIN_NAME, PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME LIKE '%test_plugin%';
    ```
    

---

### 📌 注意事项

- 插件必须预先安装并位于 `plugin_dir` 指定的目录中。
- 插件仅用于演示目的，不具备加密或安全防护机制。
- 插件会将密码明文与 `mysql.user` 表中的 `authentication_string` 字段进行比对。
- MySQL 的 `test_plugin_server` 插件**只允许 MySQL 用户通过 UNIX 套接字登录**。

🔐 这是因为该插件的设计初衷是用于测试和开发环境，它具备以下特点：

- **仅支持 UNIX 套接字连接**：不支持 TCP/IP 网络连接，因此只能在本地通过 `mysql.sock` 文件进行身份验证。
- **验证操作系统用户和组**：插件会将尝试登录的 MySQL 用户映射到操作系统用户进行验证。
- **发送明文密码**：客户端将密码以明文形式发送到服务器，这进一步限制了其在生产环境中的使用。

### 📌 总结

`test_plugin_server` 是一个用于演示和测试的插件，**不适合生产环境**，并且**只能通过本地 UNIX 套接字进行连接**，这也是它的一个安全限制。

---

如需深入了解插件的源码结构或扩展方式，可以参考 [MySQL 官方文档](https://mysql.net.cn/doc/refman/8.0/en/test-pluggable-authentication.html)或 [CSDN 博客的详细解析](https://blog.csdn.net/weixin_44496870/article/details/131576627)。


## 在生产环境中，推荐使用哪些插件进行身份验证？

在生产环境中，MySQL 提供了多种身份验证插件，以下是几种**推荐用于生产环境**的插件及其特点：

---

### ✅ 推荐的身份验证插件

| 插件名称                    | 加密机制         | 特点与适用场景                                |
| ----------------------- | ------------ | -------------------------------------- |
| `caching_sha2_password` | SHA-256 + 缓存 | **MySQL 8.0 默认插件**，兼顾安全性与性能，适合大多数生产环境  |
| `sha256_password`       | 纯 SHA-256    | 更高安全性，但性能略低，适合对安全要求极高的系统               |
| `mysql_native_password` | SHA-1        | 兼容性好，适用于旧系统，但安全性较低，**不推荐新系统使用**        |
| `auth_socket`           | 操作系统用户映射     | 仅限本地连接，适合 Linux 系统中通过 UNIX 套接字进行身份验证   |
| `PAM`（企业版）              | 外部模块         | 支持多种认证方式（如指纹、令牌），适合企业统一认证体系            |
| `LDAP`（企业版）             | LDAP 协议      | 集成企业目录服务（如 Active Directory），适合大规模用户管理 |
| `Kerberos`（企业版）         | Kerberos 协议  | 高安全性，适合政府、金融等对身份验证要求极高的场景              |
| `FIDO`（企业版）             | 生物识别/硬件密钥    | 支持智能卡、指纹、面部识别等，适合零信任架构                 |

---

### 🔐 插件选择建议

- **通用生产环境**：推荐使用 `caching_sha2_password`，它是 MySQL 8.0 的默认插件，兼顾安全性与性能。
- **高安全性要求**：使用 `sha256_password` 或企业版的 `FIDO`、`Kerberos` 插件。
- **本地自动登录**：使用 `auth_socket` 插件，适合自动化脚本或系统服务。
- **企业统一认证**：使用 `PAM` 或 `LDAP` 插件（需 MySQL Enterprise 版本）。

---

### 📌 注意事项

- 避免使用 `mysql_native_password` 和 `mysql_old_password`，因其基于 SHA-1 或更弱算法，已不再安全。
- 企业版插件（如 PAM、LDAP、Kerberos、FIDO）需购买 MySQL Enterprise Edition。
- 插件需在创建用户时显式指定，例如：
    
    ```sql
    CREATE USER 'user1'@'%' IDENTIFIED WITH caching_sha2_password BY 'StrongPassword!';
    ```
    

---

## `caching_sha2_password` 插件的工作原理

下面是对 **MySQL `caching_sha2_password` 插件的工作原理**的详细解析：

---

### 🔐 插件简介

`caching_sha2_password` 是从 **MySQL 8.0.4** 开始引入的默认身份验证插件，旨在替代旧的 `mysql_native_password` 插件，提供更强的安全性和更高的性能。

---

### ⚙️ 工作原理详解

#### 1. **密码存储机制**

- 使用 **SHA-256** 算法对密码进行多轮加密（默认 5000 次）；
- 加入 **随机盐值（salt）**，即使两个用户使用相同密码，最终的哈希值也不同；
- 加密后的结果存储在 `mysql.user` 表的 `authentication_string` 字段中。

#### 2. **身份验证流程**

插件根据是否命中缓存，分为两种认证路径：

##### ✅ 快速认证（命中缓存）

- 服务器缓存了用户的哈希摘要；
- 客户端登录时，服务器直接比对缓存，无需密码交换；
- **优点**：速度快、无需加密连接。

##### 🔁 完整认证（未命中缓存）

- 服务器未命中缓存或缓存失效；
- 客户端需发送加密后的密码；
- 若未启用 SSL，客户端使用 **RSA 公钥加密密码**，服务器用私钥解密；
- **要求**：必须是加密连接（SSL）或启用 RSA 密钥交换。

> 📌 缓存失效的情况包括：密码变更、权限刷新（如 `FLUSH PRIVILEGES`）、服务器重启等。

---

### 🧠 安全与性能兼顾

| 特性       | 描述                                 |
| -------- | ---------------------------------- |
| **安全性**  | 使用 SHA-256 + 盐 + 多轮哈希，防止暴力破解和彩虹表攻击 |
| **性能优化** | 缓存机制避免频繁加密计算和密钥交换                  |
| **兼容性**  | 支持 SSL 和 RSA 公钥加密，适应不同部署环境         |
| **默认插件** | 从 MySQL 8.0.4 起默认启用，推荐用于生产环境       |

---

### 🔧 配置建议

- 若使用非加密连接，需启用 RSA 密钥交换：
    
    ```bash
    mysql --ssl-mode=DISABLED --get-server-public-key
    ```
    
- 可通过系统变量 `caching_sha2_password_digest_rounds` 设置哈希轮数（默认 5000）；
- 若客户端不支持该插件，可手动切换为 `mysql_native_password`（不推荐）：
    
    ```sql
    ALTER USER 'user'@'host' IDENTIFIED WITH mysql_native_password BY 'password';
    ```
    

---

### 📚 延伸阅读

- [MySQL 官方文档：caching_sha2_password](https://dev.mysql.com/doc/refman/8.0/en/caching-sha2-pluggable-authentication.html)
- [技术详解文章（SegmentFault）](https://segmentfault.com/a/1190000040733952)

---

## MySQL中关于role的作用

在 **MySQL 8.0** 中引入的 **Role（角色）功能** 是一种权限管理机制，旨在简化和集中管理用户权限。以下是对其功能的简要描述：

---

### 🎭 什么是 Role？

**Role（角色）** 是一组权限的集合，可以像用户一样被授予权限，然后再将这个角色分配给一个或多个用户。这样做的好处是：

- 避免重复授权
- 简化权限变更
- 提高权限管理的可维护性和安全性

---

### 🔧 Role 的核心功能

|功能|描述|
|---|---|
|**创建角色**|使用 `CREATE ROLE` 创建一个逻辑角色|
|**授予权限**|使用 `GRANT` 将权限授予角色|
|**分配角色**|使用 `GRANT role_name TO user` 将角色分配给用户|
|**激活角色**|用户登录后需使用 `SET ROLE` 激活角色，或设置默认角色|
|**集中管理**|修改角色权限会影响所有拥有该角色的用户，无需逐个修改|

---

### 🧪 示例

```sql
-- 创建角色
CREATE ROLE 'report_reader';

-- 给角色授予权限
GRANT SELECT ON reports.* TO 'report_reader';

-- 创建用户并分配角色
CREATE USER 'alice'@'%' IDENTIFIED BY 'password';
GRANT 'report_reader' TO 'alice'@'%';

-- 设置默认角色
SET DEFAULT ROLE 'report_reader' TO 'alice'@'%';
```

---

### ⚠️ 注意事项

- 默认情况下，角色不会自动激活。可以通过设置系统变量 `activate_all_roles_on_login = ON` 实现自动激活。
- 角色本身不能登录数据库，它只是权限的容器。

---

### 📚 延伸阅读

可以查看这篇[知乎专栏文章](https://zhuanlan.zhihu.com/p/367873840)或[博客园技术解析](https://www.cnblogs.com/mysqljs/p/14703415.html)，了解更多使用技巧和最佳实践。


## 在MySQL中激活角色(role)到当前会话

可以使用以下命令：

```sql
SET ROLE role_name;
```

---

### ✅ 常见用法

|命令|说明|
|---|---|
|`SET ROLE 'role1';`|激活指定角色|
|`SET ROLE 'role1', 'role2';`|同时激活多个角色|
|`SET ROLE DEFAULT;`|激活用户的默认角色|
|`SET ROLE ALL;`|激活该用户被授予的所有角色|
|`SET ROLE NONE;`|禁用当前会话中的所有角色|
|`SET ROLE ALL EXCEPT 'role1';`|激活除指定角色外的所有角色|

> 📌 注意：只有用户已被授予的角色才能被激活。

---

### 🔍 查看当前会话激活的角色

```sql
SELECT CURRENT_ROLE();
```

---

### 📚 示例

```sql
-- 激活单个角色
SET ROLE 'report_reader';

-- 激活多个角色
SET ROLE 'report_reader', 'data_editor';

-- 禁用所有角色
SET ROLE NONE;

-- 激活默认角色
SET ROLE DEFAULT;
```

---

🔗 参考资料：

- [腾讯云开发者社区：MySQL角色激活详解](https://cloud.tencent.com/developer/article/2320657)
- [博客园：MySQL角色管理语法](https://www.cnblogs.com/zmc60/p/17035589.html)


## 如何设置登录时自动激活角色

在 MySQL 中，用户登录后默认不会自动激活所有角色。你可以通过以下两种方式实现自动激活：

---

### ✅ 方法一：设置默认角色

使用 `SET DEFAULT ROLE` 命令为用户指定默认激活的角色：

```sql
-- 为用户设置默认角色
SET DEFAULT ROLE 'role1', 'role2' TO 'username'@'host';
```

📌 示例：

```sql
SET DEFAULT ROLE 'report_reader' TO 'alice'@'%';
```

这样，`alice` 用户每次登录时，`report_reader` 角色会自动激活。

---

### ✅ 方法二：启用系统变量 `activate_all_roles_on_login`

如果你希望所有被授予的角色在用户登录时**全部自动激活**，可以设置以下系统变量：

```sql
SET GLOBAL activate_all_roles_on_login = ON;
```

> ⚠️ 注意：
> 
> - 该变量是全局变量，需有 `SUPER` 权限；
> - 该设置对所有用户生效；
> - 该变量不会持久化，重启后需重新设置，或写入配置文件。

---

### 🔍 查看当前默认角色

```sql
SELECT DEFAULT_ROLE_USER, DEFAULT_ROLE_HOST, DEFAULT_ROLE FROM mysql.default_roles;
```

---

### 🧠 小结

|方式|适用场景|是否全局|
|---|---|---|
|`SET DEFAULT ROLE`|精细控制每个用户的默认角色|否|
|`activate_all_roles_on_login`|所有用户自动激活全部角色|是|

---


## 简单规划下角色结构，比如“只读用户”、“开发者”、“DBA”等角色的权限分配

==下面是一个适用于生产环境的 **MySQL 角色权限模型草图**，适合中小型企业或开发团队使用：==

---

### 🧩 角色设计草图

|角色名称|描述|授权示例|
|---|---|---|
|`read_only`|只读用户，适合审计或BI工具|`SELECT` 权限|
|`developer`|开发人员，具备读写权限|`SELECT`, `INSERT`, `UPDATE`, `DELETE`|
|`dba`|数据库管理员，具备DDL权限|所有 DML + `CREATE`, `ALTER`, `DROP`|
|`replication`|复制账号，适用于主从复制|`REPLICATION SLAVE`, `REPLICATION CLIENT`|
|`backup_operator`|备份账号，仅能导出数据|`SELECT`, `LOCK TABLES`, `SHOW VIEW`|
|`admin`|超级管理员，拥有所有权限|`ALL PRIVILEGES`|

---

### 🛠️ SQL 示例

```sql
-- 创建角色
CREATE ROLE 'read_only', 'developer', 'dba', 'replication', 'backup_operator', 'admin';

-- 授权角色权限
GRANT SELECT ON mydb.* TO 'read_only';
GRANT SELECT, INSERT, UPDATE, DELETE ON mydb.* TO 'developer';
GRANT ALL PRIVILEGES ON mydb.* TO 'dba';
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'replication';
GRANT SELECT, LOCK TABLES, SHOW VIEW ON mydb.* TO 'backup_operator';
GRANT ALL PRIVILEGES ON *.* TO 'admin' WITH GRANT OPTION;

-- 创建用户并分配角色
CREATE USER 'alice'@'%' IDENTIFIED BY 'securepass';
GRANT 'developer' TO 'alice'@'%';
SET DEFAULT ROLE 'developer' TO 'alice'@'%';
```

---

### 🔐 安全建议

- 使用 `SET DEFAULT ROLE` 设置默认角色，避免用户登录后忘记激活；
- 对于敏感操作（如 `DROP`、`GRANT`），仅授予 `admin`；
- 使用 `REVOKE` 和 `SHOW GRANTS` 定期审查权限；
- 配合 `audit_log` 插件记录用户行为。

---

## 禁用账户的自动密码过期

在 MySQL 中，**禁用账户的自动密码过期**可以通过以下两种方式实现，分别适用于**全局设置**和**单个用户设置**：

---

### ✅ 方法一：全局禁用密码过期策略

设置全局变量 `default_password_lifetime` 为 `0` 或 `-1`，表示密码永不过期：

```sql
SET GLOBAL default_password_lifetime = 0;
```

> 📌 说明：
> 
> - 该设置会影响所有未单独设置过期策略的用户；
> - 若要永久生效，应将其写入 MySQL 配置文件（如 `my.cnf`）：
>     
>     ```ini
>     [mysqld]
>     default_password_lifetime = 0
>     ```
>     

---

### ✅ 方法二：为指定用户禁用密码过期

使用 `ALTER USER` 命令为某个用户设置密码永不过期：

```sql
ALTER USER 'username'@'host' PASSWORD EXPIRE NEVER;
```

📌 示例：

```sql
ALTER USER 'alice'@'localhost' PASSWORD EXPIRE NEVER;
```

> 这会覆盖全局策略，使该用户的密码永不过期。

---

### 🔍 查看当前设置

- 查看全局密码过期策略：
    
    ```sql
    SHOW VARIABLES LIKE 'default_password_lifetime';
    ```
    
- 查看用户是否设置了密码过期：
    
    ```sql
    SELECT user, host, password_expired FROM mysql.user;
    ```
    

---

### 📚 参考资料

- [技术分享：MySQL 密码过期机制详解](https://segmentfault.com/a/1190000040001857)
- [CSDN：MySQL 取消密码过期设置](https://blog.csdn.net/LongtengGensSupreme/article/details/135460959)

---


## 如何查看服务器使用的数字证书文件名？

在 MySQL 中，如果你想查看服务器使用的数字证书文件名，可以使用以下命令查询相关系统变量：

```sql
SHOW VARIABLES LIKE 'ssl_cert';
```

---

### 📄 命令说明

- `ssl_cert` 是一个系统变量，表示服务器使用的 **SSL 证书文件路径**；
- 执行该命令后，会显示类似如下结果：

```text
+---------------+-----------------------------+
| Variable_name | Value                       |
+---------------+-----------------------------+
| ssl_cert      | /etc/mysql/server-cert.pem  |
+---------------+-----------------------------+
```

---

### 🔍 其他相关变量（可选）

你也可以查看其他 SSL 相关文件路径：

```sql
SHOW VARIABLES LIKE 'ssl_%';
```

这将列出：

|变量名|描述|
|---|---|
|`ssl_key`|私钥文件路径|
|`ssl_ca`|CA 证书文件路径|
|`ssl_cert`|服务器证书文件路径|
|`ssl_cipher`|使用的加密算法|

---

## 在 Windows 或 Linux 系统中如何管理证书

下面我为你介绍一些常用的命令行工具，可以用于查看或管理数字证书文件，适用于 Linux 和 Windows 环境：

---

### 🐧 在 Linux / macOS 下使用 `openssl`

#### ✅ 查看证书内容

```bash
openssl x509 -in /path/to/certificate.pem -text -noout
```

- 显示证书的详细信息，如有效期、公钥、颁发者等。

#### ✅ 查看证书文件路径（服务器配置中）

- 通常在 MySQL 或 Apache、Nginx 的配置文件中查找：
    
    ```bash
    cat /etc/mysql/my.cnf | grep ssl-cert
    cat /etc/nginx/nginx.conf | grep ssl_certificate
    ```
    
- 配置参数如：
    
    ```
    ssl-cert = /etc/mysql/server-cert.pem
    ssl_certificate /etc/nginx/ssl/server.crt;
    ```
    

---

### 🪟 在 Windows 系统中使用 `certutil`

#### ✅ 查看证书信息

```powershell
certutil -dump "C:\Path\To\server-cert.cer"
```

- 显示证书内容和元数据。

#### ✅ 查找证书文件

- 通常需要搜索 MySQL 或 IIS 配置文件中的相关条目。
    
    ```powershell
    Get-Content "C:\ProgramData\MySQL\MySQL Server 8.0\my.ini" | Select-String "ssl-cert"
    ```
    

---

## `--ssl-mode`配置项说明

在 MySQL 中，`ssl-mode` 是客户端连接服务器时用于控制 **加密连接行为** 的关键配置项。它定义了客户端是否使用 SSL/TLS，以及如何验证服务器证书。下面是对各个模式的详细说明：

---

### 🔐 `--ssl-mode` 配置项详解

|模式名称|描述|是否加密连接|是否验证证书|
|---|---|---|---|
|`DISABLED`|禁用 SSL/TLS，使用明文连接。适用于测试环境，不推荐生产使用。|❌ 否|❌ 否|
|`PREFERRED`|默认模式。尝试使用加密连接，失败则回退为非加密连接。|✅ 可选|❌ 否|
|`REQUIRED`|强制使用加密连接，若无法建立则连接失败。|✅ 是|❌ 否|
|`VERIFY_CA`|要求加密连接，并验证服务器证书是否由受信任的 CA 签发。|✅ 是|✅ 验证 CA|
|`VERIFY_IDENTITY`|要求加密连接，并验证服务器证书中的主机名是否与连接目标一致。|✅ 是|✅ 验证 CA + 主机名|

---

### 🧪 示例命令

```bash
# 使用加密连接但不验证证书
mysql --ssl-mode=REQUIRED -u user -p

# 使用加密连接并验证服务器证书
mysql --ssl-mode=VERIFY_CA --ssl-ca=ca.pem -u user -p

# 使用加密连接并验证主机名
mysql --ssl-mode=VERIFY_IDENTITY --ssl-ca=ca.pem -u user -p -h db.example.com
```

---

### 📌 注意事项

- 若服务器启用了 `require_secure_transport=ON`，则客户端必须使用加密连接；
- `VERIFY_IDENTITY` 模式要求服务器证书中的 Common Name 或 Subject Alternative Name 与主机名匹配；
- 自签名证书通常无法通过 `VERIFY_IDENTITY` 验证，除非手动配置主机名匹配；
- 若未指定 `--ssl-mode`，默认行为等同于 `PREFERRED`。

---

### 🧠 推荐使用场景

| 模式                | 推荐场景             |
| ----------------- | ---------------- |
| `DISABLED`        | 本地测试环境           |
| `PREFERRED`       | 兼容性优先的开发环境       |
| `REQUIRED`        | 基础安全要求的生产环境      |
| `VERIFY_CA`       | 需要验证服务器身份的生产环境   |
| `VERIFY_IDENTITY` | 高安全性要求（如金融、政务系统） |

---

## connection_control 插件的作用

下面是对 MySQL 中 `connection_control` 插件作用的简要介绍：

---

### 🛡️ 插件作用概述

`connection_control` 插件是 MySQL 提供的一个**安全增强组件**，主要用于防止暴力破解数据库账号。它通过控制登录失败后的响应行为，提升数据库的抗攻击能力。

---

### 🔧 核心功能

- **限制连续失败登录次数**：通过设置阈值（如 3 次），当某个用户连续登录失败超过该次数后，触发延迟机制。
- **添加登录延迟**：对超过失败阈值的连接尝试，服务器会延迟响应，延迟时间可配置（如 1 秒起步，逐步递增）。
- **记录失败尝试**：配套插件 `CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS` 会将失败记录写入 `information_schema`，便于审计和排查。

---

### 📌 应用场景

|场景|插件作用|
|---|---|
|防止暴力破解|增加失败登录的响应时间|
|安全合规（如等保）|满足登录控制策略要求|
|审计登录失败行为|记录失败次数与来源IP|

---

### 🧪 示例参数（可配置）

```sql
-- 设置失败阈值为 5 次
SET GLOBAL connection_control_failed_connections_threshold = 5;

-- 设置最小延迟为 1500 毫秒
SET GLOBAL connection_control_min_connection_delay = 1500;

-- 设置最大延迟为 10 秒
SET GLOBAL connection_control_max_connection_delay = 10000;
```

---

### 以下是针对 MySQL `connection_control` 插件的**实操指南**
包括安装、配置、使用和监控方法，可以在生产环境中提升登录安全性：

---

#### 🧰 第一步：确认插件是否启用

```sql
SHOW PLUGINS LIKE 'connection_control%';
```

若未启用，可使用如下命令安装：

```sql
INSTALL PLUGIN connection_control SONAME 'connection_control.so';
INSTALL PLUGIN connection_control_failed_login_attempts SONAME 'connection_control_failed_login_attempts.so';
```

> 📌 注意：路径及插件名称可能因系统而异，确认 `plugin_dir` 配置项。

---

#### ⚙️ 第二步：配置核心参数

可通过设置系统变量来启用和调整延迟策略：

```sql
-- 设置失败登录阈值（如超过 3 次触发延迟）
SET GLOBAL connection_control_failed_connections_threshold = 3;

-- 设置最小延迟（单位毫秒）
SET GLOBAL connection_control_min_connection_delay = 1000;

-- 设置最大延迟（单位毫秒）
SET GLOBAL connection_control_max_connection_delay = 10000;
```

> 🧠 建议将参数写入 `my.cnf` 文件，使其在重启后依然生效：

```ini
[mysqld]
connection_control_failed_connections_threshold = 3
connection_control_min_connection_delay = 1000
connection_control_max_connection_delay = 10000
```

---

#### 📊 第三步：查看插件运行状态

使用以下命令查看插件的实时统计数据：

```sql
SHOW STATUS LIKE 'Connection_control%';
```

输出示例：

|变量名|含义|
|---|---|
|`Connection_control_delay_generated`|已添加延迟的连接次数|
|`Connection_control_failed_connections`|累计失败连接次数|

---

#### 📋 第四步：审计登录失败行为

启用 `connection_control_failed_login_attempts` 插件后，可以访问 `information_schema.CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS` 表：

```sql
SELECT * FROM information_schema.CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS;
```

输出内容示例：

|用户|来源 IP|主机名|最后失败时间|失败次数|
|---|---|---|---|---|
|`testuser`|`192.168.1.100`|`apphost`|`2025-07-10 14:49`|`5`|

---

### 📌 补充建议

- **高安全性场景**：可结合防火墙和 fail2ban 进一步防御暴力攻击；
- **日志审计配合**：建议开启 `general_log` 或使用 `audit_log` 插件审计登录请求；
- **自动告警**：配合监控系统如 Zabbix 或 Prometheus 设定失败登录告警规则。

---

## sys.session 表的作用

在 MySQL 中，`SELECT * FROM sys.session` 是一种用于监控和分析数据库会话状态的重要工具。该查询通过 `sys` 数据库中的 `session` 视图，提供了一种更直观、更全面的方式来查看当前数据库中所有活动会话的详细信息。

---

### 作用详解

1. **查看当前会话状态**  
    `sys.session` 提供了比传统的 `SHOW PROCESSLIST` 更丰富的信息。它不仅展示了当前正在运行的线程，还包含了与这些线程相关的详细信息，例如：
    
    - **当前执行的 SQL 语句**（`current_statement`）
    - **最后执行的 SQL 语句**（`last_statement`）
    - **连接的客户端信息**（如主机名、用户、程序）
    - **会话的执行时间**（`time`）
    - **锁等待延迟**（`lock_latency`）
    
    这些信息对于监控数据库性能、排查问题以及优化查询非常有用。
    
    > 示例：
    > 
    > ```sql
    > SELECT conn_id, user, current_statement, last_statement, time, lock_latency 
    > FROM sys.session; 
    > ```
    
2. **过滤后台线程**  
    `sys.session` 视图默认过滤了后台线程（如 InnoDB 的主线程）和 `command` 为 `Daemon` 的线程，因此它专注于展示与用户连接相关的活动会话。这种过滤使得结果更加清晰，便于分析实际的数据库负载[8](https://blog.csdn.net/Octopus21/article/details/121343779)。
    
3. **性能监控与故障排查**
    
    - **监控资源消耗**：通过 `sys.session` 可以查看每个会话的资源消耗情况，例如内存使用、锁等待时间等。这对于识别高资源消耗的查询非常有帮助。
    - **分析锁等待**：`sys.session` 提供了 `lock_latency` 字段，可以用来识别哪些会话正在等待锁资源，从而帮助解决锁争用问题[2](https://blog.csdn.net/qq_34483908/article/details/51250895)。
    - **排查未提交事务**：结合 `performance_schema.events_statements_current` ，可以通过 `sys.session` 查看事务最后执行的 SQL 语句，帮助定位未提交事务的根源[1](https://blog.csdn.net/fycghy0803/article/details/93212449)。
4. **非阻塞查询**  
    与传统的 `SHOW PROCESSLIST` 不同，`sys.session` 是非阻塞的，这意味着它不会对数据库性能产生显著影响，适合在生产环境中使用[8](https://blog.csdn.net/Octopus21/article/details/121343779)。
    
5. **多维度数据分析**  
    `sys.session` 还支持与其他 `sys` 库视图（如 `sys.host_summary` 、`sys.user_summary` ）结合使用，以从不同维度分析数据库的运行状态。例如，可以查看每个客户端 IP 或用户的连接消耗资源情况[7](https://blog.csdn.net/qq719779232/article/details/129128694)。
    

---

### 与传统方法的对比

|特性|`SHOW PROCESSLIST`|`sys.session`|
|---|---|---|
|**信息丰富度**|仅展示基本会话信息（如用户、主机、执行状态）|提供更多细节（如 SQL 语句、锁等待、资源消耗）|
|**阻塞性**|阻塞查询，可能影响性能|非阻塞，适合生产环境|
|**过滤能力**|无法过滤后台线程|默认过滤后台线程，专注于用户会话|
|**扩展性**|无法与其他视图联合分析|可与其他 `sys` 视图结合使用，提供多维分析|

---

### 实际应用场景

1. **性能调优**
    
    - 通过 `sys.session` 查看当前正在执行的 SQL 语句，识别长时间运行的查询。
    - 结合 `sys.statement_analysis` 分析 SQL 执行频率和性能瓶颈。
2. **锁问题排查**
    
    - 通过 `lock_latency` 字段识别锁等待的会话。
    - 结合 `sys.schema_table_lock_waits` 查看具体的表锁等待信息。
3. **资源监控**
    
    - 通过 `sys.session` 查看会话的内存使用情况，结合 `sys.memory_by_thread_by_current_bytes` 分析线程级内存分配。
4. **连接管理**
    
    - 监控当前连接数，识别异常连接（如长时间空闲的连接）。
    - 通过 `sys.host_summary` 和 `sys.user_summary` 查看每个客户端或用户的连接消耗情况[7](https://blog.csdn.net/qq719779232/article/details/129128694)。

---

### 使用建议

- **开启 `performance_schema`**：`sys.session` 依赖于 `performance_schema`，因此需要确保其已启用。
- **定期监控**：建议定期运行 `SELECT * FROM sys.session` ，以及时发现潜在问题。
- **结合其他视图**：将 `sys.session` 与其他 `sys` 库视图结合使用，可以获得更全面的数据库运行状态。

通过 `SELECT * FROM sys.session` ，用户可以快速了解数据库的实时运行状态，并为性能优化和问题排查提供有力支持。

